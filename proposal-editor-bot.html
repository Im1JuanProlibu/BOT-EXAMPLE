<!-- CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<style>
  /* â”€â”€ Scope â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #bot-proposal-editor {
    --accent:      #3b82f6;
    --accent-deep: #2563eb;
    --panel:       #09090e;
    --panel-soft:  #111118;
    --input-bg:    #16161f;
    --input-bd:    #2a2a38;
    --text:        #f1f5f9;
    --text-soft:   #8892a4;
    --danger:      #ef4444;
    --success:     #22c55e;
    --warn:        #fbbf24;
    font-family: 'Inter', sans-serif;
    box-sizing: border-box;
    background: var(--panel);
    min-height: 100vh;
    padding: 40px 32px;
    color: var(--text);
  }

  #bot-proposal-editor *,
  #bot-proposal-editor *::before,
  #bot-proposal-editor *::after { box-sizing: inherit; }

  /* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #bot-proposal-editor .ped-wrap { max-width: 700px; margin: 0 auto; }

  /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #bot-proposal-editor .ped-title {
    font-size: 1.55rem; font-weight: 800; color: #fff;
    margin: 0 0 4px; letter-spacing: -0.3px;
  }
  #bot-proposal-editor .ped-subtitle { font-size: 0.82rem; color: var(--text-soft); margin: 0 0 28px; }

  /* â”€â”€ Steps breadcrumb â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #bot-proposal-editor .ped-steps {
    display: flex; align-items: center; gap: 8px;
    margin-bottom: 24px; font-size: 0.75rem;
  }
  #bot-proposal-editor .sdot {
    width: 26px; height: 26px; border-radius: 50%;
    background: var(--input-bg); border: 1.5px solid var(--input-bd);
    color: var(--text-soft); display: flex; align-items: center;
    justify-content: center; font-weight: 700; font-size: 0.72rem;
    flex-shrink: 0; transition: all 0.2s;
  }
  #bot-proposal-editor .sdot.active { background: var(--accent); border-color: var(--accent); color: #fff; }
  #bot-proposal-editor .sdot.done   { background: #1e3a5f; border-color: var(--accent); color: var(--accent); }
  #bot-proposal-editor .sline { flex: 1; height: 1px; background: var(--input-bd); }
  #bot-proposal-editor .slabel { color: var(--text-soft); font-size: 0.72rem; }

  /* â”€â”€ Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #bot-proposal-editor .ped-card {
    background: var(--panel-soft); border: 1px solid var(--input-bd);
    border-radius: 12px; padding: 22px; margin-bottom: 14px;
  }
  #bot-proposal-editor .card-label {
    font-size: 0.67rem; font-weight: 700; color: var(--accent);
    text-transform: uppercase; letter-spacing: 1.3px;
    margin-bottom: 14px; display: flex; align-items: center; gap: 8px;
  }
  #bot-proposal-editor .card-label::after {
    content: ''; flex: 1; height: 1px; background: var(--input-bd);
  }

  /* â”€â”€ Form label â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #bot-proposal-editor .flabel {
    font-size: 0.75rem; color: var(--text-soft);
    display: block; margin-bottom: 6px;
  }

  /* â”€â”€ Select2 dark theme â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #bot-proposal-editor .select2-container { width: 100% !important; }
  #bot-proposal-editor .select2-container--default .select2-selection--single {
    background: var(--input-bg); border: 1px solid var(--input-bd);
    border-radius: 8px; height: 42px; transition: border-color 0.2s;
  }
  #bot-proposal-editor .select2-container--default.select2-container--open .select2-selection--single,
  #bot-proposal-editor .select2-container--default.select2-container--focus .select2-selection--single {
    border-color: var(--accent); box-shadow: 0 0 0 3px rgba(59,130,246,0.12); outline: none;
  }
  #bot-proposal-editor .select2-container--default .select2-selection--single .select2-selection__rendered {
    color: var(--text); line-height: 40px; padding-left: 14px;
    font-size: 0.88rem; font-family: 'Inter', sans-serif;
  }
  #bot-proposal-editor .select2-container--default .select2-selection--single .select2-selection__placeholder {
    color: var(--text-soft);
  }
  #bot-proposal-editor .select2-container--default .select2-selection--single .select2-selection__arrow b {
    border-top-color: var(--text-soft);
  }
  #bot-proposal-editor .select2-dropdown {
    background: #1a1a26; border: 1px solid var(--input-bd); border-radius: 8px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.5); font-family: 'Inter', sans-serif;
    font-size: 0.88rem; color: var(--text);
  }
  #bot-proposal-editor .select2-results__option { color: var(--text); padding: 8px 14px; }
  #bot-proposal-editor .select2-results__option:hover { background: #2a2a38; }
  #bot-proposal-editor .select2-container--default .select2-results__option--highlighted[aria-selected] {
    background: var(--accent); color: #fff;
  }
  #bot-proposal-editor .select2-results__group { color: var(--text-soft); font-size: 0.72rem; font-weight: 700; padding: 8px 14px 4px; }
  #bot-proposal-editor .select2-search__field {
    background: var(--input-bg) !important; color: var(--text) !important;
    border: 1px solid var(--input-bd) !important; border-radius: 6px !important;
    padding: 6px 10px !important; font-family: 'Inter', sans-serif !important;
  }

  /* â”€â”€ Native select (status) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #bot-proposal-editor .nat-select {
    width: 100%; background: var(--input-bg); border: 1px solid var(--input-bd);
    border-radius: 8px; padding: 10px 14px; font-size: 0.88rem;
    font-family: 'Inter', sans-serif; color: var(--text); outline: none;
    cursor: pointer; transition: border-color 0.2s;
  }
  #bot-proposal-editor .nat-select:focus { border-color: var(--accent); }
  #bot-proposal-editor .nat-select option { background: #1a1a26; }

  /* â”€â”€ Proposal preview â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #bot-proposal-editor .prop-preview {
    background: var(--input-bg); border: 1px solid var(--input-bd);
    border-radius: 8px; padding: 12px 14px; margin-top: 10px;
    display: none;
  }
  #bot-proposal-editor .prop-preview-title { font-weight: 600; font-size: 0.88rem; margin-bottom: 4px; }
  #bot-proposal-editor .prop-preview-meta  { font-size: 0.75rem; color: var(--text-soft); display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }

  /* â”€â”€ Products list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #bot-proposal-editor .prod-list { display: flex; flex-direction: column; gap: 8px; }
  #bot-proposal-editor .prod-row {
    display: flex; align-items: center; gap: 10px;
    background: var(--input-bg); border: 1px solid var(--input-bd);
    border-radius: 8px; padding: 10px 14px;
  }
  #bot-proposal-editor .prod-info { flex: 1; min-width: 0; }
  #bot-proposal-editor .prod-name { font-size: 0.86rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  #bot-proposal-editor .prod-sku  { font-size: 0.7rem; color: var(--text-soft); font-family: monospace; }
  #bot-proposal-editor .prod-qty {
    width: 58px; background: var(--panel-soft); border: 1px solid var(--input-bd);
    border-radius: 6px; padding: 5px 8px; font-size: 0.85rem; color: var(--text);
    text-align: center; font-family: 'Inter', sans-serif; outline: none;
  }
  #bot-proposal-editor .prod-qty:focus { border-color: var(--accent); }
  #bot-proposal-editor .prod-remove {
    background: none; border: 1px solid var(--danger); color: var(--danger);
    border-radius: 6px; padding: 4px 10px; font-size: 0.75rem; cursor: pointer;
    font-family: 'Inter', sans-serif; transition: all 0.15s; flex-shrink: 0;
  }
  #bot-proposal-editor .prod-remove:hover { background: rgba(239,68,68,0.12); }
  #bot-proposal-editor .prod-empty {
    text-align: center; padding: 20px; color: var(--text-soft); font-size: 0.83rem;
  }

  /* â”€â”€ Add product row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #bot-proposal-editor .add-row {
    display: flex; gap: 8px; align-items: flex-end; flex-wrap: wrap;
  }
  #bot-proposal-editor .add-row .s2-wrap { flex: 1; min-width: 180px; }
  #bot-proposal-editor .add-qty {
    width: 68px; background: var(--input-bg); border: 1px solid var(--input-bd);
    border-radius: 8px; padding: 10px 8px; font-size: 0.88rem; color: var(--text);
    text-align: center; font-family: 'Inter', sans-serif; outline: none;
  }
  #bot-proposal-editor .add-qty:focus { border-color: var(--accent); }

  /* â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #bot-proposal-editor .btn {
    padding: 11px 18px; border-radius: 8px; font-size: 0.85rem; font-weight: 700;
    font-family: 'Inter', sans-serif; cursor: pointer; border: none;
    transition: all 0.15s; display: inline-flex; align-items: center;
    justify-content: center; gap: 8px;
  }
  #bot-proposal-editor .btn:disabled { opacity: 0.45; cursor: not-allowed; }
  #bot-proposal-editor .btn-primary  { background: var(--accent); color: #fff; width: 100%; margin-top: 10px; }
  #bot-proposal-editor .btn-primary:hover:not(:disabled)  { background: var(--accent-deep); transform: translateY(-1px); }
  #bot-proposal-editor .btn-success  { background: var(--success); color: #fff; width: 100%; }
  #bot-proposal-editor .btn-success:hover:not(:disabled)  { filter: brightness(1.1); transform: translateY(-1px); }
  #bot-proposal-editor .btn-ghost {
    background: transparent; border: 1px solid var(--input-bd); color: var(--text-soft);
    font-size: 0.78rem; padding: 7px 14px;
  }
  #bot-proposal-editor .btn-ghost:hover { border-color: var(--accent); color: var(--accent); }
  #bot-proposal-editor .btn-add {
    background: rgba(59,130,246,0.12); border: 1px solid var(--accent);
    color: var(--accent); padding: 10px 16px; white-space: nowrap;
  }
  #bot-proposal-editor .btn-add:hover { background: rgba(59,130,246,0.22); }

  /* â”€â”€ Spinner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #bot-proposal-editor .spinner {
    width: 15px; height: 15px; border: 2px solid rgba(255,255,255,0.3);
    border-top-color: #fff; border-radius: 50%;
    animation: ped-spin 0.7s linear infinite; display: none;
  }
  @keyframes ped-spin { to { transform: rotate(360deg); } }

  /* â”€â”€ Status badge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #bot-proposal-editor .badge {
    display: inline-flex; align-items: center; padding: 2px 9px;
    border-radius: 999px; font-size: 0.67rem; font-weight: 700;
    text-transform: uppercase; letter-spacing: 0.4px;
  }
  #bot-proposal-editor .badge-Ready { background: rgba(34,197,94,0.15);  color: #22c55e; }
  #bot-proposal-editor .badge-Draft { background: rgba(251,191,36,0.15); color: #fbbf24; }
  #bot-proposal-editor .badge-Sent  { background: rgba(59,130,246,0.15); color: #3b82f6; }

  /* â”€â”€ Proposal info header in editor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #bot-proposal-editor .prop-head { margin-bottom: 16px; }
  #bot-proposal-editor .prop-head-title { font-size: 1rem; font-weight: 700; margin-bottom: 6px; }
  #bot-proposal-editor .prop-head-meta  { font-size: 0.75rem; color: var(--text-soft); display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }

  /* â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #bot-proposal-editor .ped-toast {
    position: fixed; bottom: 20px; right: 20px; z-index: 9999;
    background: #1e2030; border: 1px solid var(--input-bd); border-radius: 10px;
    padding: 12px 18px; font-size: 0.83rem; color: var(--text);
    box-shadow: 0 8px 32px rgba(0,0,0,0.5); display: none; max-width: 300px;
  }
  #bot-proposal-editor .ped-toast.ok  { border-color: var(--success); }
  #bot-proposal-editor .ped-toast.err { border-color: var(--danger); }

  /* â”€â”€ Loading overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #bot-proposal-editor .ped-loading {
    display: flex; align-items: center; gap: 10px;
    padding: 18px; color: var(--text-soft); font-size: 0.83rem; justify-content: center;
  }
  #bot-proposal-editor .ped-loading .spinner { border-top-color: var(--accent); display: block; }

  /* â”€â”€ Meta row (count, back) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #bot-proposal-editor .row-meta {
    display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;
  }
  #bot-proposal-editor .meta-count { font-size: 0.75rem; color: var(--text-soft); }

  @media (max-width: 600px) {
    #bot-proposal-editor { padding: 24px 14px; }
    #bot-proposal-editor .add-row .s2-wrap { width: 100%; }
  }
</style>

<!-- HTML -->
<div id="bot-proposal-editor">
  <div class="ped-wrap">

    <h2 class="ped-title">Editor de Propuestas</h2>
    <p class="ped-subtitle">Busca, edita y actualiza propuestas por asesor</p>

    <!-- Breadcrumb steps -->
    <div class="ped-steps">
      <div class="sdot active" id="sdot-1">1</div>
      <span class="slabel">Asesor</span>
      <div class="sline"></div>
      <div class="sdot" id="sdot-2">2</div>
      <span class="slabel">Propuesta</span>
      <div class="sline"></div>
      <div class="sdot" id="sdot-3">3</div>
      <span class="slabel">Editar</span>
    </div>

    <!-- â”€â”€ Step 1: Asesor â”€â”€ -->
    <div id="step-1">
      <div class="ped-card">
        <div class="card-label">Asesor</div>
        <label class="flabel">Selecciona el asesor</label>
        <select id="agent-select">
          <option value="">Cargando asesores...</option>
        </select>
        <button class="btn btn-primary" id="btn-load-proposals" onclick="loadProposals()" disabled>
          Ver propuestas â†’
          <span class="spinner" id="sp-load"></span>
        </button>
      </div>
    </div>

    <!-- â”€â”€ Step 2: Propuesta â”€â”€ -->
    <div id="step-2" style="display:none">
      <div class="ped-card">
        <div class="card-label">Propuesta</div>
        <div class="row-meta">
          <button class="btn btn-ghost" onclick="goStep(1)">â† Volver</button>
          <span class="meta-count" id="proposals-count"></span>
        </div>
        <label class="flabel">Selecciona la propuesta a editar</label>
        <select id="proposal-select">
          <option value="">Seleccione una propuesta</option>
        </select>
        <div class="prop-preview" id="prop-preview">
          <div class="prop-preview-title" id="prev-title"></div>
          <div class="prop-preview-meta" id="prev-meta"></div>
        </div>
        <button class="btn btn-primary" id="btn-open-editor" onclick="loadProposalDetail()" disabled>
          Editar propuesta â†’
          <span class="spinner" id="sp-detail"></span>
        </button>
      </div>
    </div>

    <!-- â”€â”€ Step 3: Editor â”€â”€ -->
    <div id="step-3" style="display:none">

      <!-- Info + estado -->
      <div class="ped-card">
        <div class="row-meta" style="margin-bottom:16px">
          <button class="btn btn-ghost" onclick="goStep(2)">â† Volver</button>
        </div>
        <div class="prop-head">
          <div class="prop-head-title" id="ed-title">â€”</div>
          <div class="prop-head-meta">
            <span id="ed-num"></span>
            <span id="ed-badge"></span>
          </div>
        </div>
        <div class="card-label">Estado de la propuesta</div>
        <select class="nat-select" id="ed-status">
          <option value="Draft">Draft â€” Borrador</option>
          <option value="Ready">Ready â€” Lista para enviar</option>
          <option value="Sent">Sent â€” Enviada</option>
        </select>
      </div>

      <!-- Productos actuales -->
      <div class="ped-card">
        <div class="card-label">Productos en la propuesta</div>
        <div class="prod-list" id="ed-products">
          <div class="ped-loading">
            <div class="spinner"></div> Cargando productos...
          </div>
        </div>
      </div>

      <!-- Agregar producto -->
      <div class="ped-card">
        <div class="card-label">Agregar producto</div>
        <div class="add-row">
          <div class="s2-wrap">
            <select id="add-prod-select">
              <option value="">Buscar en catÃ¡logo...</option>
            </select>
          </div>
          <input type="number" class="add-qty" id="add-qty" value="1" min="1" max="999" placeholder="Cant.">
          <button class="btn btn-add" onclick="addProduct()">+ Agregar</button>
        </div>
      </div>

      <!-- Guardar -->
      <button class="btn btn-success" id="btn-save" onclick="saveProposal()">
        <span id="btn-save-text">Guardar cambios</span>
        <span class="spinner" id="sp-save"></span>
      </button>

    </div>

  </div>
</div>

<!-- Toast -->
<div class="ped-toast" id="ped-toast"></div>

<!-- SCRIPTS â€” orden exacto -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
<script src="https://s3.amazonaws.com/cdn.nodriza.io/sdk/nodriza@lastest/nodriza-sdk.bundle.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.11/lodash.core.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
  // â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var domain      = 'customer-design.prolibu.com';
  var bearerToken = 'a6a0278f-b899-44ec-9870-417381a5b6dc';
  var rolesString = 'agent';

  var authHeaders = { Authorization: 'Bearer ' + bearerToken };

  // â”€â”€ SDK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var nodriza = new Nodriza({ hostname: domain });

  // â”€â”€ Estado â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var agentsList     = [];
  var proposalsList  = [];
  var productsCatalog = [];
  var currentProposal = null;
  var currentProducts = []; // [{id, quantity, name}]

  // â”€â”€ Utilidades â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function toast(msg, type) {
    var $t = $('#ped-toast');
    $t.text(msg).removeClass('ok err').addClass(type === 'ok' ? 'ok' : 'err').fadeIn(200);
    setTimeout(function () { $t.fadeOut(400); }, 3200);
  }

  function badge(status) {
    return '<span class="badge badge-' + status + '">' + status + '</span>';
  }

  function goStep(n) {
    $('#step-1, #step-2, #step-3').hide();
    $('#step-' + n).show();
    [1, 2, 3].forEach(function (i) {
      $('#sdot-' + i).removeClass('active done');
      if (i < n) $('#sdot-' + i).addClass('done');
      else if (i === n) $('#sdot-' + i).addClass('active');
    });
  }

  // â”€â”€ AJAX helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function api(method, path, data, cb, cbErr) {
    var opts = {
      url: 'https://' + domain + path,
      type: method,
      headers: authHeaders,
      success: cb,
      error: cbErr || function (e) { console.error(method, path, e); }
    };
    if (method === 'PUT' || method === 'POST') {
      opts.data = JSON.stringify(data);
      opts.contentType = 'application/json';
    } else {
      opts.data = data;
    }
    $.ajax(opts);
  }

  // â”€â”€ Step 1: cargar asesores â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function loadAgents() {
    $.ajax({
      url: 'https://' + domain + '/v1/publicservices/getAgents',
      type: 'GET',
      data: { status: 'active', roles: [rolesString] },
      success: function (res) {
        var list = Array.isArray(res) ? res : (res.results || []);
        agentsList = list.map(function (a) {
          return {
            email:     a.email || '',
            firstName: a.firstName || '',
            lastName:  a.lastName  || '',
            id:        a.id || a._id || ''
          };
        });
        console.log('Asesores cargados:', agentsList.length);
        var opts = '<option value="">Seleccione un asesor</option>';
        agentsList.forEach(function (a) {
          opts += '<option value="' + a.email + '">' + a.firstName + ' ' + a.lastName + '</option>';
        });
        $('#agent-select').html(opts).trigger('change');
      },
      error: function (e) { console.error('loadAgents error:', e); toast('Error cargando asesores', 'err'); }
    });
  }

  // â”€â”€ Step 1 â†’ Step 2: cargar propuestas del asesor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function loadProposals() {
    var email = $('#agent-select').val();
    if (!email) return toast('Selecciona un asesor', 'err');

    $('#btn-load-proposals').prop('disabled', true);
    $('#sp-load').show();

    // Intentar primero con responsible=email (sin filtro de status â€” filtramos client-side)
    api('GET', '/v1/proposal', { responsible: email, limit: 200 },
      function (res) {
        console.log('Proposals por responsible:', res);
        var list = Array.isArray(res) ? res : (res.data || res.results || []);
        if (list.length === 0) {
          // Fallback: createdBy con el firstName del asesor
          var agent = agentsList.find(function (a) { return a.email === email; });
          var firstName = agent ? agent.firstName : '';
          api('GET', '/v1/proposal', { createdBy: firstName, limit: 200 },
            function (res2) {
              console.log('Proposals por createdBy:', res2);
              var list2 = Array.isArray(res2) ? res2 : (res2.data || res2.results || []);
              renderProposalStep(list2);
            },
            function (e) { console.error('proposals fallback:', e); renderProposalStep([]); }
          );
        } else {
          renderProposalStep(list);
        }
        $('#btn-load-proposals').prop('disabled', false);
        $('#sp-load').hide();
      },
      function (e) {
        console.error('loadProposals error:', e);
        toast('Error cargando propuestas: ' + e.status, 'err');
        $('#btn-load-proposals').prop('disabled', false);
        $('#sp-load').hide();
      }
    );
  }

  function renderProposalStep(all) {
    // Solo Ready y Draft
    proposalsList = all.filter(function (p) {
      return p.status === 'Ready' || p.status === 'Draft';
    });
    console.log('Propuestas Ready+Draft:', proposalsList.length, 'â€” todas:', all.length);
    $('#proposals-count').text(proposalsList.length + ' propuestas (Ready + Draft)');

    var ready = proposalsList.filter(function (p) { return p.status === 'Ready'; });
    var draft  = proposalsList.filter(function (p) { return p.status === 'Draft'; });

    var opts = '<option value="">Seleccione una propuesta</option>';
    if (ready.length) {
      opts += '<optgroup label="âœ… Ready (' + ready.length + ')">';
      ready.forEach(function (p) {
        opts += '<option value="' + (p.id || p._id) + '">[Ready] ' + (p.title || p.proposalNumber || p.id) + '</option>';
      });
      opts += '</optgroup>';
    }
    if (draft.length) {
      opts += '<optgroup label="ğŸ“ Draft (' + draft.length + ')">';
      draft.forEach(function (p) {
        opts += '<option value="' + (p.id || p._id) + '">[Draft] ' + (p.title || p.proposalNumber || p.id) + '</option>';
      });
      opts += '</optgroup>';
    }

    if ($('#proposal-select').data('select2')) $('#proposal-select').select2('destroy');
    $('#proposal-select').html(opts).select2({ width: '100%', placeholder: 'Seleccione una propuesta' });
    $('#proposal-select').on('change', onProposalChange);

    goStep(2);
  }

  function onProposalChange() {
    var id = $('#proposal-select').val();
    if (!id) {
      $('#prop-preview').hide();
      $('#btn-open-editor').prop('disabled', true);
      return;
    }
    var p = proposalsList.find(function (x) { return (x.id || x._id) === id; });
    if (p) {
      $('#prev-title').text(p.title || '(Sin tÃ­tulo)');
      $('#prev-meta').html('NÂ° ' + (p.proposalNumber || 'â€”') + ' &nbsp;|&nbsp; ' + badge(p.status) + (p.relatedUser ? ' &nbsp;|&nbsp; ' + p.relatedUser : ''));
      $('#prop-preview').show();
    }
    $('#btn-open-editor').prop('disabled', false);
  }

  // â”€â”€ Step 2 â†’ Step 3: detalle de propuesta â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function loadProposalDetail() {
    var id = $('#proposal-select').val();
    if (!id) return;

    $('#btn-open-editor').prop('disabled', true);
    $('#sp-detail').show();

    api('GET', '/v1/proposal/' + id, {},
      function (res) {
        console.log('Detalle propuesta completo:', JSON.stringify(res, null, 2));
        currentProposal = res;
        currentProducts = parseProducts(res.products);
        console.log('Products parseados:', currentProducts);

        renderEditor();
        goStep(3);
        $('#btn-open-editor').prop('disabled', false);
        $('#sp-detail').hide();
      },
      function (e) {
        console.error('loadProposalDetail error:', e);
        toast('Error al cargar detalle: ' + e.status, 'err');
        $('#btn-open-editor').prop('disabled', false);
        $('#sp-detail').hide();
      }
    );
  }

  // â”€â”€ Parsear products del detalle (puede ser array, string JSON, objeto) â”€â”€
  function parseProducts(raw) {
    if (!raw) return [];
    if (Array.isArray(raw)) return raw.map(normProd);
    if (typeof raw === 'string') {
      try { return JSON.parse(raw).map(normProd); } catch (e) { return []; }
    }
    if (typeof raw === 'object') return [normProd(raw)];
    return [];
  }

  function normProd(p) {
    var sku = p.id || p.sku || p._id || '';
    var name = p.name || '';
    // Intentar obtener el nombre del catÃ¡logo si no viene en la propuesta
    if (!name && productsCatalog.length) {
      var found = productsCatalog.find(function (x) { return x.sku === sku; });
      if (found) name = found.name;
    }
    return { id: sku, quantity: parseInt(p.quantity) || 1, name: name || sku };
  }

  // â”€â”€ Render editor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderEditor() {
    var p = currentProposal;
    $('#ed-title').text(p.title || '(Sin tÃ­tulo)');
    $('#ed-num').text('NÂ° ' + (p.proposalNumber || 'â€”'));
    $('#ed-badge').html(badge(p.status || 'Draft'));
    $('#ed-status').val(p.status || 'Draft');
    renderProductList();
  }

  function renderProductList() {
    var $list = $('#ed-products');
    if (!currentProducts.length) {
      $list.html('<div class="prod-empty">No hay productos en esta propuesta.<br>Agrega uno desde el catÃ¡logo.</div>');
      return;
    }
    var html = '<div class="prod-list">';
    currentProducts.forEach(function (prod, i) {
      html += '<div class="prod-row">' +
        '<div class="prod-info">' +
          '<div class="prod-name">' + (prod.name || prod.id) + '</div>' +
          '<div class="prod-sku">' + prod.id + '</div>' +
        '</div>' +
        '<input type="number" class="prod-qty" value="' + prod.quantity + '" min="1" max="999" data-idx="' + i + '">' +
        '<button class="prod-remove" onclick="removeProduct(' + i + ')">âœ•</button>' +
      '</div>';
    });
    html += '</div>';
    $list.html(html);
    $list.find('.prod-qty').on('change input', function () {
      var idx = parseInt($(this).data('idx'));
      currentProducts[idx].quantity = Math.max(1, parseInt($(this).val()) || 1);
    });
  }

  function removeProduct(idx) {
    currentProducts.splice(idx, 1);
    renderProductList();
    toast('Producto eliminado', 'ok');
  }

  function addProduct() {
    var sku = $('#add-prod-select').val();
    var qty = Math.max(1, parseInt($('#add-qty').val()) || 1);
    if (!sku) return toast('Selecciona un producto del catÃ¡logo', 'err');

    var exists = currentProducts.find(function (p) { return p.id === sku; });
    if (exists) {
      exists.quantity += qty;
      renderProductList();
      toast('Cantidad actualizada (' + exists.quantity + ')', 'ok');
    } else {
      var cat = productsCatalog.find(function (p) { return p.sku === sku; });
      currentProducts.push({ id: sku, quantity: qty, name: cat ? cat.name : sku });
      renderProductList();
      toast('Producto agregado', 'ok');
    }
    $('#add-prod-select').val('').trigger('change');
    $('#add-qty').val(1);
  }

  // â”€â”€ Guardar propuesta â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function saveProposal() {
    if (!currentProposal) return;
    var id = currentProposal.id || currentProposal._id;

    $('#btn-save').prop('disabled', true);
    $('#btn-save-text').text('Guardando...');
    $('#sp-save').show();

    var newStatus = $('#ed-status').val();
    var productsPayload = currentProducts.map(function (p) {
      return { id: p.id, quantity: p.quantity };
    });

    var body = { status: newStatus, products: productsPayload };
    console.log('PUT /v1/proposal/' + id, body);

    $.ajax({
      url: 'https://' + domain + '/v1/proposal/' + id,
      type: 'PUT',
      data: JSON.stringify(body),
      contentType: 'application/json',
      headers: authHeaders,
      success: function (res) {
        console.log('Propuesta actualizada:', res);
        currentProposal = res;
        $('#ed-badge').html(badge(newStatus));
        toast('âœ… Propuesta guardada correctamente', 'ok');
        $('#btn-save').prop('disabled', false);
        $('#btn-save-text').text('Guardar cambios');
        $('#sp-save').hide();
      },
      error: function (e) {
        console.error('saveProposal error:', e);
        // Intentar con products como string JSON (por si la API lo espera asÃ­)
        if (e.status === 400 && typeof body.products !== 'string') {
          console.log('Reintentando con products como JSON string...');
          body.products = JSON.stringify(productsPayload);
          $.ajax({
            url: 'https://' + domain + '/v1/proposal/' + id,
            type: 'PUT',
            data: JSON.stringify(body),
            contentType: 'application/json',
            headers: authHeaders,
            success: function (res2) {
              console.log('Guardado con products como string:', res2);
              currentProposal = res2;
              $('#ed-badge').html(badge(newStatus));
              toast('âœ… Propuesta guardada correctamente', 'ok');
              $('#btn-save').prop('disabled', false);
              $('#btn-save-text').text('Guardar cambios');
              $('#sp-save').hide();
            },
            error: function (e2) {
              console.error('saveProposal retry error:', e2);
              toast('âŒ Error al guardar (' + e2.status + ')', 'err');
              $('#btn-save').prop('disabled', false);
              $('#btn-save-text').text('Guardar cambios');
              $('#sp-save').hide();
            }
          });
        } else {
          toast('âŒ Error al guardar (' + e.status + ')', 'err');
          $('#btn-save').prop('disabled', false);
          $('#btn-save-text').text('Guardar cambios');
          $('#sp-save').hide();
        }
      }
    });
  }

  // â”€â”€ Cargar catÃ¡logo de productos â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function loadCatalog() {
    api('GET', '/v1/product?disabled=false', {},
      function (res) {
        var items = res.data || res || [];
        productsCatalog = items.map(function (p) { return { sku: p.sku, name: p.name }; });
        console.log('CatÃ¡logo:', productsCatalog.length, 'productos');
        var opts = '<option value="">Buscar en catÃ¡logo...</option>';
        _.sortBy(productsCatalog, 'name').forEach(function (p) {
          opts += '<option value="' + p.sku + '">' + p.name + ' (' + p.sku + ')</option>';
        });
        $('#add-prod-select').html(opts).select2({ width: '100%', placeholder: 'Buscar en catÃ¡logo...' });
      }
    );
  }

  // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  $(document).ready(function () {
    goStep(1);

    $('#agent-select').select2({ width: '100%', placeholder: 'Cargando asesores...' });
    $('#agent-select').on('change', function () {
      $('#btn-load-proposals').prop('disabled', !$(this).val());
    });

    loadAgents();
    loadCatalog();
  });
</script>
