<!-- CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<style>
  /* ── Variables & reset ──────────────────────────────────────── */
  #bot-proposal-editor {
    --accent:      #3b82f6;
    --accent-deep: #2563eb;
    --accent-glow: rgba(59,130,246,0.14);
    --bg:          #07070f;
    --surface:     rgba(255,255,255,0.025);
    --surface-2:   rgba(255,255,255,0.045);
    --border:      rgba(255,255,255,0.07);
    --text:        #dde3ef;
    --text-soft:   #5a6478;
    --danger:      #f87171;
    --success:     #34d399;
    --warn:        #fbbf24;
    font-family: 'Inter', sans-serif;
    box-sizing: border-box;
    background: var(--bg);
    min-height: 100vh;
    padding: 52px 28px;
    color: var(--text);
  }
  #bot-proposal-editor *, #bot-proposal-editor *::before, #bot-proposal-editor *::after { box-sizing: inherit; }

  /* ── Wrap ───────────────────────────────────────────────────── */
  #bot-proposal-editor .ped-wrap { max-width: 560px; margin: 0 auto; }

  /* ── Header ─────────────────────────────────────────────────── */
  #bot-proposal-editor .ped-title {
    font-size: 1.35rem; font-weight: 700; color: #fff;
    margin: 0 0 6px; letter-spacing: -0.4px;
  }
  #bot-proposal-editor .ped-subtitle { font-size: 0.79rem; color: var(--text-soft); margin: 0 0 36px; }

  /* ── Steps ──────────────────────────────────────────────────── */
  #bot-proposal-editor .ped-steps {
    display: flex; align-items: flex-start; margin-bottom: 32px;
  }
  #bot-proposal-editor .step-node {
    display: flex; flex-direction: column; align-items: center; gap: 7px;
  }
  #bot-proposal-editor .step-line {
    flex: 1; height: 1px; background: var(--border); margin-top: 14px; transition: background 0.3s;
  }
  #bot-proposal-editor .step-line.done { background: rgba(59,130,246,0.35); }
  #bot-proposal-editor .sdot {
    width: 28px; height: 28px; border-radius: 50%; flex-shrink: 0;
    background: var(--surface-2); border: 1.5px solid var(--border);
    color: var(--text-soft); display: flex; align-items: center;
    justify-content: center; font-weight: 600; font-size: 0.72rem;
    transition: all 0.25s; position: relative;
  }
  #bot-proposal-editor .sdot.active {
    background: var(--accent); border-color: var(--accent); color: #fff;
    box-shadow: 0 0 0 4px var(--accent-glow);
  }
  #bot-proposal-editor .sdot.done {
    background: transparent; border-color: var(--accent); color: var(--accent);
  }
  #bot-proposal-editor .sdot.done .snum { display: none; }
  #bot-proposal-editor .sdot.done::after { content: '✓'; font-size: 0.75rem; }
  #bot-proposal-editor .slabel {
    font-size: 0.67rem; font-weight: 500; color: var(--text-soft);
    letter-spacing: 0.2px; white-space: nowrap;
  }
  #bot-proposal-editor .step-node.s-active .slabel { color: var(--accent); }
  #bot-proposal-editor .step-node.s-done  .slabel { color: rgba(59,130,246,0.55); }

  /* ── Card ───────────────────────────────────────────────────── */
  #bot-proposal-editor .ped-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 16px; padding: 24px; margin-bottom: 10px;
  }
  #bot-proposal-editor .card-sec {
    font-size: 0.63rem; font-weight: 700; color: var(--text-soft);
    text-transform: uppercase; letter-spacing: 1.5px;
    margin-bottom: 16px; display: flex; align-items: center; gap: 10px;
  }
  #bot-proposal-editor .card-sec::after { content: ''; flex: 1; height: 1px; background: var(--border); }

  /* ── Label ───────────────────────────────────────────────────── */
  #bot-proposal-editor .flabel { font-size: 0.72rem; font-weight: 500; color: var(--text-soft); display: block; margin-bottom: 8px; }

  /* ── Select2 ─────────────────────────────────────────────────── */
  #bot-proposal-editor .select2-container { width: 100% !important; }
  #bot-proposal-editor .select2-container--default .select2-selection--single {
    background: rgba(255,255,255,0.04); border: 1px solid var(--border);
    border-radius: 10px; height: 44px; transition: all 0.2s;
  }
  #bot-proposal-editor .select2-container--default.select2-container--open .select2-selection--single,
  #bot-proposal-editor .select2-container--default.select2-container--focus .select2-selection--single {
    border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); outline: none;
  }
  #bot-proposal-editor .select2-container--default .select2-selection--single .select2-selection__rendered {
    color: var(--text); line-height: 42px; padding-left: 14px; font-size: 0.875rem; font-family: 'Inter', sans-serif;
  }
  #bot-proposal-editor .select2-container--default .select2-selection--single .select2-selection__placeholder { color: var(--text-soft); }
  #bot-proposal-editor .select2-container--default .select2-selection--single .select2-selection__arrow b { border-top-color: var(--text-soft); }
  #bot-proposal-editor .select2-dropdown {
    background: #10101c; border: 1px solid var(--border); border-radius: 10px;
    box-shadow: 0 12px 40px rgba(0,0,0,0.65); font-family: 'Inter', sans-serif; font-size: 0.875rem; overflow: hidden;
  }
  #bot-proposal-editor .select2-results__option { color: var(--text); padding: 9px 14px; }
  #bot-proposal-editor .select2-results__option:hover { background: rgba(255,255,255,0.05); }
  #bot-proposal-editor .select2-container--default .select2-results__option--highlighted[aria-selected] { background: var(--accent); color: #fff; }
  #bot-proposal-editor .select2-results__group { color: var(--text-soft); font-size: 0.65rem; font-weight: 700; padding: 9px 14px 5px; letter-spacing: 1px; text-transform: uppercase; }
  #bot-proposal-editor .select2-search__field {
    background: rgba(255,255,255,0.04) !important; color: var(--text) !important;
    border: 1px solid var(--border) !important; border-radius: 7px !important;
    padding: 7px 11px !important; font-family: 'Inter', sans-serif !important; font-size: 0.875rem !important;
  }

  /* ── Native select ───────────────────────────────────────────── */
  #bot-proposal-editor .nat-select {
    width: 100%; background: rgba(255,255,255,0.04); border: 1px solid var(--border);
    border-radius: 10px; padding: 11px 36px 11px 14px; font-size: 0.875rem;
    font-family: 'Inter', sans-serif; color: var(--text); outline: none; cursor: pointer;
    appearance: none; transition: all 0.2s;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='7' viewBox='0 0 12 7'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%235a6478' stroke-width='1.5' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
    background-repeat: no-repeat; background-position: right 14px center;
  }
  #bot-proposal-editor .nat-select:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }
  #bot-proposal-editor .nat-select option { background: #10101c; }

  /* ── Proposal preview ───────────────────────────────────────── */
  #bot-proposal-editor .prop-preview {
    background: rgba(59,130,246,0.05); border: 1px solid rgba(59,130,246,0.15);
    border-radius: 10px; padding: 14px 16px; margin-top: 12px; display: none;
  }
  #bot-proposal-editor .prop-preview-title { font-weight: 600; font-size: 0.875rem; margin-bottom: 5px; }
  #bot-proposal-editor .prop-preview-meta { font-size: 0.72rem; color: var(--text-soft); display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }

  /* ── Products list ──────────────────────────────────────────── */
  #bot-proposal-editor .prod-list { display: flex; flex-direction: column; gap: 6px; }
  #bot-proposal-editor .prod-row {
    display: flex; align-items: center; gap: 10px;
    background: var(--surface-2); border: 1px solid var(--border);
    border-radius: 10px; padding: 10px 14px; transition: border-color 0.15s;
  }
  #bot-proposal-editor .prod-row:hover { border-color: rgba(255,255,255,0.13); }
  #bot-proposal-editor .prod-info { flex: 1; min-width: 0; }
  #bot-proposal-editor .prod-name { font-size: 0.84rem; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  #bot-proposal-editor .prod-sku  { font-size: 0.66rem; color: var(--text-soft); font-family: monospace; margin-top: 2px; }
  #bot-proposal-editor .prod-qty {
    width: 58px; background: var(--surface); border: 1px solid var(--border);
    border-radius: 7px; padding: 5px 8px; font-size: 0.84rem; color: var(--text);
    text-align: center; font-family: 'Inter', sans-serif; outline: none; transition: border-color 0.2s;
  }
  #bot-proposal-editor .prod-qty:focus { border-color: var(--accent); }
  #bot-proposal-editor .prod-remove {
    background: none; border: 1px solid rgba(248,113,113,0.25); color: var(--danger);
    border-radius: 7px; padding: 5px 10px; font-size: 0.72rem; cursor: pointer;
    font-family: 'Inter', sans-serif; transition: all 0.15s; flex-shrink: 0;
  }
  #bot-proposal-editor .prod-remove:hover { background: rgba(248,113,113,0.08); border-color: var(--danger); }
  #bot-proposal-editor .prod-empty { text-align: center; padding: 24px 16px; color: var(--text-soft); font-size: 0.79rem; line-height: 1.6; }

  /* ── Add product ─────────────────────────────────────────────── */
  #bot-proposal-editor .add-row { display: flex; gap: 8px; align-items: flex-end; flex-wrap: wrap; }
  #bot-proposal-editor .add-row .s2-wrap { flex: 1; min-width: 180px; }
  #bot-proposal-editor .add-qty {
    width: 70px; background: rgba(255,255,255,0.04); border: 1px solid var(--border);
    border-radius: 10px; padding: 11px 8px; font-size: 0.875rem; color: var(--text);
    text-align: center; font-family: 'Inter', sans-serif; outline: none; transition: border-color 0.2s;
  }
  #bot-proposal-editor .add-qty:focus { border-color: var(--accent); }

  /* ── Proposal head in editor ─────────────────────────────────── */
  #bot-proposal-editor .prop-head { margin-bottom: 20px; padding-bottom: 18px; border-bottom: 1px solid var(--border); }
  #bot-proposal-editor .prop-head-title { font-size: 1rem; font-weight: 700; margin-bottom: 7px; line-height: 1.35; }
  #bot-proposal-editor .prop-head-meta { font-size: 0.72rem; color: var(--text-soft); display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }

  /* ── Buttons ─────────────────────────────────────────────────── */
  #bot-proposal-editor .btn {
    padding: 11px 20px; border-radius: 10px; font-size: 0.84rem; font-weight: 600;
    font-family: 'Inter', sans-serif; cursor: pointer; border: none;
    transition: all 0.15s; display: inline-flex; align-items: center;
    justify-content: center; gap: 8px;
  }
  #bot-proposal-editor .btn:disabled { opacity: 0.35; cursor: not-allowed; pointer-events: none; }

  #bot-proposal-editor .btn-primary { background: var(--accent); color: #fff; width: 100%; margin-top: 14px; }
  #bot-proposal-editor .btn-primary:hover { background: var(--accent-deep); transform: translateY(-1px); box-shadow: 0 4px 18px rgba(59,130,246,0.3); }

  #bot-proposal-editor .btn-save {
    width: 100%; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
    color: #fff; margin-top: 4px; box-shadow: 0 2px 14px rgba(34,197,94,0.18);
  }
  #bot-proposal-editor .btn-save:hover { filter: brightness(1.07); transform: translateY(-1px); box-shadow: 0 4px 22px rgba(34,197,94,0.3); }

  #bot-proposal-editor .btn-ghost {
    background: transparent; border: 1px solid var(--border);
    color: var(--text-soft); font-size: 0.78rem; padding: 7px 14px;
  }
  #bot-proposal-editor .btn-ghost:hover { border-color: rgba(255,255,255,0.18); color: var(--text); }

  #bot-proposal-editor .btn-add {
    background: var(--accent-glow); border: 1px solid rgba(59,130,246,0.28);
    color: var(--accent); padding: 11px 16px; white-space: nowrap;
  }
  #bot-proposal-editor .btn-add:hover { background: rgba(59,130,246,0.2); }

  #bot-proposal-editor .btn-open { background: var(--accent); color: #fff; flex: 1; }
  #bot-proposal-editor .btn-open:hover { background: var(--accent-deep); }

  #bot-proposal-editor .btn-copy {
    background: var(--surface-2); border: 1px solid var(--border); color: var(--text-soft);
  }
  #bot-proposal-editor .btn-copy:hover { color: var(--text); border-color: rgba(255,255,255,0.18); }

  /* ── Spinner ─────────────────────────────────────────────────── */
  #bot-proposal-editor .spinner {
    width: 14px; height: 14px; border: 1.8px solid rgba(255,255,255,0.22);
    border-top-color: #fff; border-radius: 50%; animation: ped-spin 0.65s linear infinite;
    display: none; flex-shrink: 0;
  }
  #bot-proposal-editor .sp-blue {
    width: 14px; height: 14px; border: 1.8px solid rgba(59,130,246,0.2);
    border-top-color: var(--accent); border-radius: 50%; animation: ped-spin 0.65s linear infinite;
  }
  @keyframes ped-spin { to { transform: rotate(360deg); } }

  /* ── Badge ───────────────────────────────────────────────────── */
  #bot-proposal-editor .badge {
    display: inline-flex; align-items: center; padding: 3px 9px; border-radius: 999px;
    font-size: 0.64rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;
  }
  #bot-proposal-editor .badge-Ready { background: rgba(52,211,153,0.12); color: #34d399; }
  #bot-proposal-editor .badge-Draft { background: rgba(251,191,36,0.12);  color: #fbbf24; }
  #bot-proposal-editor .badge-Sent  { background: rgba(59,130,246,0.12);  color: #3b82f6; }

  /* ── Row meta ────────────────────────────────────────────────── */
  #bot-proposal-editor .row-meta { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
  #bot-proposal-editor .meta-count { font-size: 0.72rem; color: var(--text-soft); }

  /* ── Loading ─────────────────────────────────────────────────── */
  #bot-proposal-editor .ped-loading { display: flex; align-items: center; gap: 10px; padding: 20px; color: var(--text-soft); font-size: 0.79rem; justify-content: center; }

  /* ── Save success panel ──────────────────────────────────────── */
  #bot-proposal-editor .save-success {
    display: none; background: rgba(52,211,153,0.05);
    border: 1px solid rgba(52,211,153,0.18); border-radius: 14px;
    padding: 20px; margin-top: 10px;
  }
  #bot-proposal-editor .ss-head { display: flex; align-items: center; gap: 12px; margin-bottom: 14px; }
  #bot-proposal-editor .ss-icon {
    width: 32px; height: 32px; border-radius: 50%;
    background: rgba(52,211,153,0.12); color: #34d399;
    display: flex; align-items: center; justify-content: center;
    font-size: 0.9rem; flex-shrink: 0;
  }
  #bot-proposal-editor .ss-title { font-weight: 700; font-size: 0.88rem; color: #34d399; }
  #bot-proposal-editor .ss-sub   { font-size: 0.72rem; color: var(--text-soft); margin-top: 2px; }
  #bot-proposal-editor .ss-url {
    background: rgba(255,255,255,0.03); border: 1px solid var(--border);
    border-radius: 9px; padding: 9px 13px; margin-bottom: 12px;
    font-size: 0.72rem; word-break: break-all; line-height: 1.5;
  }
  #bot-proposal-editor .ss-url a { color: var(--accent); text-decoration: none; font-weight: 500; }
  #bot-proposal-editor .ss-url a:hover { text-decoration: underline; }
  #bot-proposal-editor .ss-actions { display: flex; gap: 8px; }

  /* ── Toast ───────────────────────────────────────────────────── */
  #bot-proposal-editor .ped-toast {
    position: fixed; bottom: 24px; right: 24px; z-index: 9999;
    background: #12121e; border: 1px solid var(--border); border-radius: 12px;
    padding: 11px 18px; font-size: 0.79rem; color: var(--text);
    box-shadow: 0 12px 40px rgba(0,0,0,0.55); display: none; max-width: 280px;
    font-family: 'Inter', sans-serif;
  }
  #bot-proposal-editor .ped-toast.ok  { border-color: rgba(52,211,153,0.4); }
  #bot-proposal-editor .ped-toast.err { border-color: rgba(248,113,113,0.4); }

  @media (max-width: 600px) {
    #bot-proposal-editor { padding: 28px 16px; }
    #bot-proposal-editor .add-row .s2-wrap { width: 100%; }
    #bot-proposal-editor .ss-actions { flex-direction: column; }
  }
</style>

<!-- HTML -->
<div id="bot-proposal-editor">
  <div class="ped-wrap">

    <h2 class="ped-title">Editor de propuestas</h2>
    <p class="ped-subtitle">Actualiza estado y productos de las propuestas por asesor</p>

    <!-- Steps -->
    <div class="ped-steps">
      <div class="step-node s-active" id="si-1">
        <div class="sdot active" id="sdot-1"><span class="snum">1</span></div>
        <div class="slabel">Asesor</div>
      </div>
      <div class="step-line" id="sl-12"></div>
      <div class="step-node" id="si-2">
        <div class="sdot" id="sdot-2"><span class="snum">2</span></div>
        <div class="slabel">Propuesta</div>
      </div>
      <div class="step-line" id="sl-23"></div>
      <div class="step-node" id="si-3">
        <div class="sdot" id="sdot-3"><span class="snum">3</span></div>
        <div class="slabel">Editar</div>
      </div>
    </div>

    <!-- ── Step 1: Asesor ── -->
    <div id="step-1">
      <div class="ped-card">
        <div class="card-sec">Asesor</div>
        <label class="flabel">Selecciona el asesor</label>
        <select id="agent-select"><option value="">Cargando asesores...</option></select>
        <button class="btn btn-primary" id="btn-load-proposals" onclick="loadProposals()" disabled>
          Ver propuestas <span class="spinner" id="sp-load"></span>
        </button>
      </div>
    </div>

    <!-- ── Step 2: Propuesta ── -->
    <div id="step-2" style="display:none">
      <div class="ped-card">
        <div class="row-meta">
          <button class="btn btn-ghost" onclick="goStep(1)">← Volver</button>
          <span class="meta-count" id="proposals-count"></span>
        </div>
        <div class="card-sec">Propuesta</div>
        <label class="flabel">Selecciona la propuesta a editar</label>
        <select id="proposal-select"><option value="">—</option></select>
        <div class="prop-preview" id="prop-preview">
          <div class="prop-preview-title" id="prev-title"></div>
          <div class="prop-preview-meta" id="prev-meta"></div>
        </div>
        <button class="btn btn-primary" id="btn-open-editor" onclick="loadProposalDetail()" disabled>
          Editar propuesta <span class="spinner" id="sp-detail"></span>
        </button>
      </div>
    </div>

    <!-- ── Step 3: Editor ── -->
    <div id="step-3" style="display:none">

      <!-- Info + estado -->
      <div class="ped-card">
        <div class="row-meta" style="margin-bottom:0">
          <button class="btn btn-ghost" onclick="goStep(2)">← Volver</button>
        </div>
        <div class="prop-head">
          <div class="prop-head-title" id="ed-title">—</div>
          <div class="prop-head-meta">
            <span id="ed-num"></span>
            <span id="ed-badge"></span>
          </div>
        </div>
        <div class="card-sec">Estado</div>
        <select class="nat-select" id="ed-status">
          <option value="Draft">Draft — Borrador</option>
          <option value="Ready">Ready — Lista para enviar</option>
          <option value="Sent">Sent — Enviada</option>
        </select>
      </div>

      <!-- Productos -->
      <div class="ped-card">
        <div class="card-sec">Productos</div>
        <div id="ed-products">
          <div class="ped-loading"><div class="sp-blue"></div> Cargando productos...</div>
        </div>
      </div>

      <!-- Agregar producto -->
      <div class="ped-card">
        <div class="card-sec">Agregar producto</div>
        <div class="add-row">
          <div class="s2-wrap">
            <select id="add-prod-select"><option value="">Buscar en catálogo...</option></select>
          </div>
          <input type="number" class="add-qty" id="add-qty" value="1" min="1" max="999" placeholder="Cant.">
          <button class="btn btn-add" onclick="addProduct()">+ Agregar</button>
        </div>
      </div>

      <!-- Guardar -->
      <button class="btn btn-save" id="btn-save" onclick="saveProposal()">
        <span id="btn-save-text">Guardar cambios</span>
        <span class="spinner" id="sp-save"></span>
      </button>

      <!-- Panel de éxito con URL -->
      <div class="save-success" id="save-success">
        <div class="ss-head">
          <div class="ss-icon">✓</div>
          <div>
            <div class="ss-title">Guardado correctamente</div>
            <div class="ss-sub" id="ss-sub"></div>
          </div>
        </div>
        <div class="ss-url">
          <a id="prop-url-link" href="#" target="_blank" rel="noopener"></a>
        </div>
        <div class="ss-actions">
          <button class="btn btn-open" onclick="openPropUrl()">Abrir propuesta →</button>
          <button class="btn btn-copy" id="btn-copy" onclick="copyPropUrl()">Copiar enlace</button>
        </div>
      </div>

    </div>

  </div>
</div>

<!-- Toast -->
<div class="ped-toast" id="ped-toast"></div>

<!-- SCRIPTS — orden exacto -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
<script src="https://s3.amazonaws.com/cdn.nodriza.io/sdk/nodriza@lastest/nodriza-sdk.bundle.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.11/lodash.core.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
  // ── Config ───────────────────────────────────────────────────
  var domain      = 'customer-design.prolibu.com';
  var bearerToken = 'a6a0278f-b899-44ec-9870-417381a5b6dc';
  var rolesString = 'agent';
  var authHeaders = { Authorization: 'Bearer ' + bearerToken };

  // ── SDK ──────────────────────────────────────────────────────
  var nodriza = new Nodriza({ hostname: domain });

  // ── Estado ──────────────────────────────────────────────────
  var agentsList      = [];
  var proposalsList   = [];
  var productsCatalog = [];
  var currentProposal = null;
  var currentProducts = [];
  var propUrl         = '';

  // ── Utilidades ───────────────────────────────────────────────
  function toast(msg, type) {
    var $t = $('#ped-toast');
    $t.text(msg).removeClass('ok err').addClass(type === 'ok' ? 'ok' : 'err').fadeIn(200);
    setTimeout(function () { $t.fadeOut(400); }, 3200);
  }

  function badge(status) {
    return '<span class="badge badge-' + status + '">' + status + '</span>';
  }

  function goStep(n) {
    $('#step-1, #step-2, #step-3').hide();
    $('#step-' + n).show();
    if (n < 3) $('#save-success').hide();

    [1, 2, 3].forEach(function (i) {
      $('#sdot-' + i).removeClass('active done');
      $('#si-' + i).removeClass('s-active s-done');
      if (i < n) { $('#sdot-' + i).addClass('done'); $('#si-' + i).addClass('s-done'); }
      else if (i === n) { $('#sdot-' + i).addClass('active'); $('#si-' + i).addClass('s-active'); }
    });

    // Colorear líneas conectoras según progreso
    $('#sl-12').toggleClass('done', n >= 2);
    $('#sl-23').toggleClass('done', n >= 3);
  }

  // ── AJAX helper ──────────────────────────────────────────────
  function api(method, path, data, cb, cbErr) {
    var opts = {
      url: 'https://' + domain + path,
      type: method, headers: authHeaders, success: cb,
      error: cbErr || function (e) { console.error(method, path, e); }
    };
    if (method === 'PUT' || method === 'POST') {
      opts.data = JSON.stringify(data); opts.contentType = 'application/json';
    } else { opts.data = data; }
    $.ajax(opts);
  }

  // ── Cargar asesores ──────────────────────────────────────────
  function loadAgents() {
    $.ajax({
      url: 'https://' + domain + '/v1/publicservices/getAgents',
      type: 'GET', data: { status: 'active', roles: [rolesString] },
      success: function (res) {
        var list = Array.isArray(res) ? res : (res.results || []);
        agentsList = list.map(function (a) {
          return { email: a.email || '', firstName: a.firstName || '', lastName: a.lastName || '', id: a.id || a._id || '' };
        });
        console.log('Asesores cargados:', agentsList.length);
        var opts = '<option value="">Seleccione un asesor</option>';
        agentsList.forEach(function (a) {
          opts += '<option value="' + a.email + '">' + a.firstName + ' ' + a.lastName + '</option>';
        });
        $('#agent-select').html(opts).trigger('change');
      },
      error: function (e) { console.error('loadAgents error:', e); toast('Error cargando asesores', 'err'); }
    });
  }

  // ── Cargar propuestas ────────────────────────────────────────
  function loadProposals() {
    var email = $('#agent-select').val();
    if (!email) return toast('Selecciona un asesor', 'err');

    var agent   = agentsList.find(function (a) { return a.email === email; });
    var agentId = agent ? agent.id : '';
    if (!agentId) return toast('No se encontró el ID del asesor', 'err');

    $('#btn-load-proposals').prop('disabled', true);
    $('#sp-load').show();

    console.log('Cargando propuestas de asesor id:', agentId);
    api('GET', '/v1/proposal', { createdBy: agentId, limit: 200 },
      function (res) {
        var list = Array.isArray(res) ? res : (res.data || res.results || []);
        console.log('Propuestas recibidas:', list.length);
        $('#btn-load-proposals').prop('disabled', false); $('#sp-load').hide();
        renderProposalStep(list);
      },
      function (e) {
        console.error('loadProposals error:', e);
        toast('Error ' + e.status + ' al cargar propuestas', 'err');
        $('#btn-load-proposals').prop('disabled', false); $('#sp-load').hide();
      }
    );
  }

  function renderProposalStep(all) {
    proposalsList = all.filter(function (p) { return p.status === 'Ready' || p.status === 'Draft'; });
    console.log('Ready+Draft:', proposalsList.length, '/ total:', all.length);
    $('#proposals-count').text(proposalsList.length + ' propuestas (Ready + Draft)');

    var ready = proposalsList.filter(function (p) { return p.status === 'Ready'; });
    var draft  = proposalsList.filter(function (p) { return p.status === 'Draft'; });

    var opts = '<option value="">Seleccione una propuesta</option>';
    if (ready.length) {
      opts += '<optgroup label="Ready (' + ready.length + ')">';
      ready.forEach(function (p) { opts += '<option value="' + (p.id || p._id) + '">' + (p.title || p.proposalNumber || p.id) + '</option>'; });
      opts += '</optgroup>';
    }
    if (draft.length) {
      opts += '<optgroup label="Draft (' + draft.length + ')">';
      draft.forEach(function (p) { opts += '<option value="' + (p.id || p._id) + '">' + (p.title || p.proposalNumber || p.id) + '</option>'; });
      opts += '</optgroup>';
    }
    if ($('#proposal-select').data('select2')) $('#proposal-select').select2('destroy');
    $('#proposal-select').html(opts).select2({ width: '100%', placeholder: 'Seleccione una propuesta' });
    $('#proposal-select').on('change', onProposalChange);
    goStep(2);
  }

  function onProposalChange() {
    var id = $('#proposal-select').val();
    if (!id) { $('#prop-preview').hide(); $('#btn-open-editor').prop('disabled', true); return; }
    var p = proposalsList.find(function (x) { return (x.id || x._id) === id; });
    if (p) {
      $('#prev-title').text(p.title || '(Sin título)');
      $('#prev-meta').html('N° ' + (p.proposalNumber || '—') + ' &nbsp;&middot;&nbsp; ' + badge(p.status));
      $('#prop-preview').show();
    }
    $('#btn-open-editor').prop('disabled', false);
  }

  // ── Cargar detalle de propuesta ───────────────────────────────
  function loadProposalDetail() {
    var id = $('#proposal-select').val();
    if (!id) return;
    $('#btn-open-editor').prop('disabled', true); $('#sp-detail').show();

    api('GET', '/v1/proposal/' + id, {},
      function (res) {
        console.log('Detalle propuesta:', JSON.stringify(res, null, 2));
        currentProposal = res;
        currentProducts = parseProducts(res.products);
        renderEditor(); goStep(3);
        $('#btn-open-editor').prop('disabled', false); $('#sp-detail').hide();
      },
      function (e) {
        console.error('loadProposalDetail error:', e);
        toast('Error al cargar detalle: ' + e.status, 'err');
        $('#btn-open-editor').prop('disabled', false); $('#sp-detail').hide();
      }
    );
  }

  // ── Parsear products ──────────────────────────────────────────
  function parseProducts(raw) {
    if (!raw) return [];
    if (Array.isArray(raw)) return raw.map(normProd);
    if (typeof raw === 'string') { try { return JSON.parse(raw).map(normProd); } catch (e) { return []; } }
    if (typeof raw === 'object') return [normProd(raw)];
    return [];
  }
  function normProd(p) {
    var sku  = p.id || p.sku || p._id || '';
    var name = p.name || '';
    if (!name && productsCatalog.length) {
      var found = productsCatalog.find(function (x) { return x.sku === sku; });
      if (found) name = found.name;
    }
    return { id: sku, quantity: parseInt(p.quantity) || 1, name: name || sku };
  }

  // ── Render editor ─────────────────────────────────────────────
  function renderEditor() {
    var p = currentProposal;
    $('#ed-title').text(p.title || '(Sin título)');
    $('#ed-num').text('N° ' + (p.proposalNumber || '—'));
    $('#ed-badge').html(badge(p.status || 'Draft'));
    $('#ed-status').val(p.status || 'Draft');
    renderProductList();
  }

  function renderProductList() {
    var $list = $('#ed-products');
    if (!currentProducts.length) {
      $list.html('<div class="prod-empty">Sin productos.<br>Agrega uno desde el catálogo.</div>'); return;
    }
    var html = '<div class="prod-list">';
    currentProducts.forEach(function (prod, i) {
      html += '<div class="prod-row">' +
        '<div class="prod-info">' +
          '<div class="prod-name">' + (prod.name || prod.id) + '</div>' +
          '<div class="prod-sku">' + prod.id + '</div>' +
        '</div>' +
        '<input type="number" class="prod-qty" value="' + prod.quantity + '" min="1" max="999" data-idx="' + i + '">' +
        '<button class="prod-remove" onclick="removeProduct(' + i + ')">✕</button>' +
      '</div>';
    });
    html += '</div>';
    $list.html(html);
    $list.find('.prod-qty').on('change input', function () {
      var idx = parseInt($(this).data('idx'));
      currentProducts[idx].quantity = Math.max(1, parseInt($(this).val()) || 1);
    });
  }

  function removeProduct(idx) {
    currentProducts.splice(idx, 1); renderProductList(); toast('Producto eliminado', 'ok');
  }

  function addProduct() {
    var sku = $('#add-prod-select').val();
    var qty = Math.max(1, parseInt($('#add-qty').val()) || 1);
    if (!sku) return toast('Selecciona un producto del catálogo', 'err');
    var exists = currentProducts.find(function (p) { return p.id === sku; });
    if (exists) { exists.quantity += qty; renderProductList(); toast('Cantidad actualizada (' + exists.quantity + ')', 'ok'); }
    else {
      var cat = productsCatalog.find(function (p) { return p.sku === sku; });
      currentProducts.push({ id: sku, quantity: qty, name: cat ? cat.name : sku });
      renderProductList(); toast('Producto agregado', 'ok');
    }
    $('#add-prod-select').val('').trigger('change');
    $('#add-qty').val(1);
  }

  // ── Guardar propuesta ─────────────────────────────────────────
  function saveProposal() {
    if (!currentProposal) return;
    var id = currentProposal.id || currentProposal._id;
    $('#btn-save').prop('disabled', true); $('#btn-save-text').text('Guardando...'); $('#sp-save').show();
    $('#save-success').hide();

    var newStatus       = $('#ed-status').val();
    var productsPayload = currentProducts.map(function (p) { return { id: p.id, quantity: p.quantity }; });
    var body            = { status: newStatus, products: productsPayload };
    console.log('PUT /v1/proposal/' + id, body);

    function onSuccess(res) {
      console.log('Propuesta actualizada:', res);
      currentProposal = res;

      // URL: intentar campo de respuesta, fallback a URL construida
      var pid = res.id || res._id || id;
      propUrl = res.url || res.link || res.shareUrl || res.proposalUrl || ('https://' + domain + '/proposal/' + pid);
      console.log('URL de propuesta:', propUrl);

      $('#ed-badge').html(badge(newStatus));
      $('#ss-sub').text('Estado actualizado: ' + newStatus);
      $('#prop-url-link').attr('href', propUrl).text(propUrl);
      $('#save-success').fadeIn(250);

      $('#btn-save').prop('disabled', false); $('#btn-save-text').text('Guardar cambios'); $('#sp-save').hide();
    }

    function onError(e, retry) {
      console.error('saveProposal error:', e);
      if (e.status === 400 && retry) {
        console.log('Reintentando con products como JSON string...');
        body.products = JSON.stringify(productsPayload);
        $.ajax({ url: 'https://' + domain + '/v1/proposal/' + id, type: 'PUT', data: JSON.stringify(body), contentType: 'application/json', headers: authHeaders, success: onSuccess, error: function (e2) { onError(e2, false); } });
      } else {
        toast('Error al guardar (' + e.status + ')', 'err');
        $('#btn-save').prop('disabled', false); $('#btn-save-text').text('Guardar cambios'); $('#sp-save').hide();
      }
    }

    $.ajax({ url: 'https://' + domain + '/v1/proposal/' + id, type: 'PUT', data: JSON.stringify(body), contentType: 'application/json', headers: authHeaders, success: onSuccess, error: function (e) { onError(e, true); } });
  }

  // ── URL helpers ───────────────────────────────────────────────
  function openPropUrl() { if (propUrl) window.open(propUrl, '_blank'); }

  function copyPropUrl() {
    if (!propUrl) return;
    var done = function () { $('#btn-copy').text('¡Copiado!'); setTimeout(function () { $('#btn-copy').text('Copiar enlace'); }, 2000); };
    if (navigator.clipboard) { navigator.clipboard.writeText(propUrl).then(done); }
    else {
      var tmp = document.createElement('input'); tmp.value = propUrl;
      document.body.appendChild(tmp); tmp.select(); document.execCommand('copy'); document.body.removeChild(tmp); done();
    }
  }

  // ── Catálogo ──────────────────────────────────────────────────
  function loadCatalog() {
    api('GET', '/v1/product?disabled=false', {},
      function (res) {
        var items = res.data || res || [];
        productsCatalog = items.map(function (p) { return { sku: p.sku, name: p.name }; });
        console.log('Catálogo:', productsCatalog.length, 'productos');
        var opts = '<option value="">Buscar en catálogo...</option>';
        _.sortBy(productsCatalog, 'name').forEach(function (p) {
          opts += '<option value="' + p.sku + '">' + p.name + ' (' + p.sku + ')</option>';
        });
        $('#add-prod-select').html(opts).select2({ width: '100%', placeholder: 'Buscar en catálogo...' });
      }
    );
  }

  // ── Init ──────────────────────────────────────────────────────
  $(document).ready(function () {
    goStep(1);
    $('#agent-select').select2({ width: '100%', placeholder: 'Cargando asesores...' });
    $('#agent-select').on('change', function () { $('#btn-load-proposals').prop('disabled', !$(this).val()); });
    loadAgents();
    loadCatalog();
  });
</script>
