<!-- CSS -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css">

<style>
  /* â”€â”€ Reset / Variables â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #bot-fanalca-login {
    --accent:      #e84c1e;
    --accent-deep: #c93f17;
    --accent-glow: rgba(232,76,30,0.16);
    --bg:          #0a0a12;
    --surface:     rgba(255,255,255,0.04);
    --surface-2:   rgba(255,255,255,0.07);
    --border:      rgba(255,255,255,0.08);
    --text:        #e2e8f0;
    --text-soft:   #4a5568;
    --danger:      #f87171;
    --success:     #34d399;
    font-family: 'Inter', sans-serif;
    box-sizing: border-box;
    background: var(--bg);
    min-height: 100vh;
    color: var(--text);
    /* Mobile app container */
    max-width: 500px;
    margin: 0 auto;
    position: relative;
    overflow-x: hidden;
  }
  #bot-fanalca-login *, #bot-fanalca-login *::before, #bot-fanalca-login *::after {
    box-sizing: inherit;
  }
  #bot-fanalca-login .view { display: none; }
  #bot-fanalca-login .view.active { display: block; }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     LOGIN SCREEN
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  #bot-fanalca-login .login-wrap {
    min-height: 100vh;
    display: flex; align-items: center; justify-content: center;
    padding: 32px 24px;
    flex-direction: column;
  }
  #bot-fanalca-login .login-brand {
    display: flex; flex-direction: column; align-items: center; margin-bottom: 40px;
  }
  #bot-fanalca-login .login-brand-icon {
    width: 64px; height: 64px; border-radius: 18px;
    background: var(--accent); display: flex; align-items: center; justify-content: center;
    font-size: 1.8rem; margin-bottom: 16px;
    box-shadow: 0 16px 48px rgba(232,76,30,0.35);
  }
  #bot-fanalca-login .login-brand-name {
    font-size: 1.4rem; font-weight: 800; color: #fff; letter-spacing: -0.5px;
  }
  #bot-fanalca-login .login-brand-sub {
    font-size: 0.75rem; color: var(--text-soft); margin-top: 4px;
  }
  #bot-fanalca-login .login-card {
    width: 100%;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 24px; padding: 28px 24px;
  }
  #bot-fanalca-login .login-title {
    font-size: 1rem; font-weight: 700; color: #fff; margin: 0 0 20px; text-align: center;
  }
  #bot-fanalca-login .login-err {
    background: rgba(248,113,113,0.08); border: 1px solid rgba(248,113,113,0.25);
    border-radius: 12px; padding: 12px 16px; font-size: 0.8rem; color: var(--danger);
    margin-bottom: 16px; display: none; text-align: center;
  }
  #bot-fanalca-login .field { margin-bottom: 12px; }
  #bot-fanalca-login .field label {
    display: block; font-size: 0.72rem; font-weight: 600;
    color: var(--text-soft); margin-bottom: 8px; letter-spacing: 0.03em;
    text-transform: uppercase;
  }
  #bot-fanalca-login .field input {
    width: 100%; background: rgba(255,255,255,0.05);
    border: 1.5px solid var(--border); border-radius: 14px;
    padding: 14px 16px; font-size: 1rem; font-family: 'Inter', sans-serif;
    color: var(--text); outline: none; transition: all 0.2s;
    -webkit-appearance: none;
  }
  #bot-fanalca-login .field input:focus {
    border-color: var(--accent); box-shadow: 0 0 0 4px var(--accent-glow);
  }
  #bot-fanalca-login .field input::placeholder { color: var(--text-soft); }
  #bot-fanalca-login .btn-login {
    width: 100%; background: var(--accent); border: none; border-radius: 16px;
    padding: 16px; color: #fff; font-size: 1rem; font-weight: 700;
    font-family: 'Inter', sans-serif; cursor: pointer; margin-top: 8px;
    display: flex; align-items: center; justify-content: center; gap: 8px;
    transition: all 0.2s; min-height: 52px;
    box-shadow: 0 8px 24px rgba(232,76,30,0.35);
  }
  #bot-fanalca-login .btn-login:hover   { background: var(--accent-deep); }
  #bot-fanalca-login .btn-login:active  { transform: scale(0.98); }
  #bot-fanalca-login .btn-login:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     APP HEADER
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  #bot-fanalca-login .app-header {
    background: rgba(10,10,18,0.95);
    border-bottom: 1px solid var(--border);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    padding: 0 20px;
    height: 56px;
    display: flex; align-items: center; justify-content: space-between;
    position: sticky; top: 0; z-index: 200;
  }
  #bot-fanalca-login .app-header-left  { display: flex; align-items: center; gap: 10px; }
  #bot-fanalca-login .app-header-right { display: flex; align-items: center; gap: 8px; }
  #bot-fanalca-login .btn-icon {
    width: 36px; height: 36px; border-radius: 10px;
    background: var(--surface); border: 1px solid var(--border);
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; transition: all 0.18s; font-size: 1rem;
    font-family: 'Inter', sans-serif; color: var(--text-soft);
  }
  #bot-fanalca-login .btn-icon:hover { border-color: var(--accent); color: var(--accent); }
  #bot-fanalca-login .header-page {
    font-size: 0.95rem; font-weight: 700; color: #fff;
  }
  #bot-fanalca-login .user-chip {
    background: var(--surface-2); border: 1px solid var(--border);
    border-radius: 20px; padding: 5px 12px;
    font-size: 0.75rem; font-weight: 600; color: var(--text);
    max-width: 130px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     BOTTOM NAV (mobile tabs)
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  #bot-fanalca-login .bottom-nav {
    position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
    width: 100%; max-width: 500px;
    background: rgba(10,10,18,0.97);
    border-top: 1px solid var(--border);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    display: none; /* shown post-login via JS */
    grid-template-columns: repeat(3, 1fr);
    padding: 8px 0 max(8px, env(safe-area-inset-bottom));
    z-index: 200;
  }
  #bot-fanalca-login .bottom-nav.visible { display: grid; }
  #bot-fanalca-login .nav-tab {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    gap: 4px; padding: 8px 4px; cursor: pointer; transition: all 0.18s;
    border: none; background: transparent; font-family: 'Inter', sans-serif;
    color: var(--text-soft);
  }
  #bot-fanalca-login .nav-tab.active { color: var(--accent); }
  #bot-fanalca-login .nav-tab:active  { transform: scale(0.93); }
  #bot-fanalca-login .nav-tab-icon { font-size: 1.4rem; line-height: 1; }
  #bot-fanalca-login .nav-tab-label { font-size: 0.65rem; font-weight: 600; letter-spacing: 0.02em; }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     VIEW SCROLL AREA (accounts for sticky header + bottom nav)
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  #bot-fanalca-login .view-scroll {
    padding: 20px 20px 100px; /* 100px bottom = bottom nav height */
  }
  #bot-fanalca-login .view-title {
    font-size: 1.15rem; font-weight: 800; color: #fff; margin: 0 0 20px;
    letter-spacing: -0.3px;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     HOME
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  #bot-fanalca-login .home-wrap {
    padding: 24px 20px 100px;
  }
  #bot-fanalca-login .home-greeting {
    font-size: 1.5rem; font-weight: 800; color: #fff;
    margin: 0 0 4px; letter-spacing: -0.5px; line-height: 1.2;
  }
  #bot-fanalca-login .home-greeting em { color: var(--accent); font-style: normal; }
  #bot-fanalca-login .home-sub {
    font-size: 0.82rem; color: var(--text-soft); margin: 0 0 28px;
  }
  #bot-fanalca-login .home-section-title {
    font-size: 0.7rem; font-weight: 700; color: var(--text-soft);
    text-transform: uppercase; letter-spacing: 0.08em; margin: 0 0 12px;
  }
  #bot-fanalca-login .home-cards {
    display: flex; flex-direction: column; gap: 12px;
  }
  #bot-fanalca-login .home-card {
    background: var(--surface);
    border: 1.5px solid var(--border);
    border-radius: 20px;
    padding: 20px;
    cursor: pointer; transition: all 0.2s;
    display: flex; align-items: center; gap: 16px;
    -webkit-tap-highlight-color: transparent;
  }
  #bot-fanalca-login .home-card:active {
    transform: scale(0.98); border-color: var(--accent);
    background: rgba(232,76,30,0.07);
  }
  #bot-fanalca-login .hc-icon-wrap {
    width: 52px; height: 52px; border-radius: 15px; flex-shrink: 0;
    display: flex; align-items: center; justify-content: center;
    font-size: 1.5rem;
  }
  #bot-fanalca-login .hc-icon-wrap.blue   { background: rgba(96,165,250,0.12); }
  #bot-fanalca-login .hc-icon-wrap.green  { background: rgba(52,211,153,0.12); }
  #bot-fanalca-login .hc-icon-wrap.orange { background: rgba(232,76,30,0.12); }
  #bot-fanalca-login .hc-body { flex: 1; min-width: 0; }
  #bot-fanalca-login .hc-title {
    font-size: 0.95rem; font-weight: 700; color: #fff; margin-bottom: 3px;
  }
  #bot-fanalca-login .hc-desc {
    font-size: 0.75rem; color: var(--text-soft); line-height: 1.5;
  }
  #bot-fanalca-login .hc-arrow {
    color: var(--text-soft); font-size: 1rem; flex-shrink: 0;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     FILTER BAR
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  #bot-fanalca-login .filter-bar {
    display: flex; gap: 8px; margin-bottom: 16px;
    overflow-x: auto; padding-bottom: 4px;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
  }
  #bot-fanalca-login .filter-bar::-webkit-scrollbar { display: none; }
  #bot-fanalca-login .filter-btn {
    background: var(--surface); border: 1.5px solid var(--border);
    border-radius: 20px; padding: 7px 18px;
    font-size: 0.77rem; font-weight: 600; color: var(--text-soft);
    font-family: 'Inter', sans-serif; cursor: pointer; transition: all 0.18s;
    white-space: nowrap; min-height: 36px;
    -webkit-tap-highlight-color: transparent;
  }
  #bot-fanalca-login .filter-btn.active { background: var(--accent); border-color: var(--accent); color: #fff; }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PROPOSAL CARDS (list)
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  #bot-fanalca-login .prop-cards { display: flex; flex-direction: column; gap: 10px; }
  #bot-fanalca-login .prop-card {
    background: var(--surface); border: 1.5px solid var(--border);
    border-radius: 18px; padding: 16px;
    display: flex; flex-direction: column; gap: 12px;
    transition: border-color 0.18s;
  }
  #bot-fanalca-login .pc-info {}
  #bot-fanalca-login .pc-title {
    font-size: 0.9rem; font-weight: 700; color: #fff;
    margin-bottom: 6px; line-height: 1.3;
  }
  #bot-fanalca-login .pc-meta {
    display: flex; align-items: center; gap: 8px; flex-wrap: wrap;
    font-size: 0.72rem; color: var(--text-soft);
  }
  #bot-fanalca-login .pc-actions {
    display: flex; gap: 8px; border-top: 1px solid var(--border);
    padding-top: 12px;
  }
  #bot-fanalca-login .pc-actions a,
  #bot-fanalca-login .pc-actions button {
    flex: 1; text-align: center; min-height: 40px;
    display: flex; align-items: center; justify-content: center;
  }
  #bot-fanalca-login .prop-empty {
    text-align: center; padding: 56px 24px;
    color: var(--text-soft); font-size: 0.85rem; line-height: 1.8;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     FORM CARDS
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  #bot-fanalca-login .ped-card {
    background: var(--surface); border: 1.5px solid var(--border);
    border-radius: 20px; padding: 18px 18px; margin-bottom: 14px;
  }
  #bot-fanalca-login .card-sec {
    font-size: 0.67rem; font-weight: 700; color: var(--text-soft);
    text-transform: uppercase; letter-spacing: 0.09em; margin-bottom: 14px;
  }
  #bot-fanalca-login .flabel {
    display: block; font-size: 0.72rem; font-weight: 600;
    color: var(--text-soft); margin-bottom: 8px;
    text-transform: uppercase; letter-spacing: 0.03em;
  }
  #bot-fanalca-login .nat-select,
  #bot-fanalca-login .nat-input {
    width: 100%; background: rgba(255,255,255,0.05);
    border: 1.5px solid var(--border); border-radius: 14px;
    padding: 13px 15px; font-size: 0.9rem; font-family: 'Inter', sans-serif;
    color: var(--text); outline: none; transition: border-color 0.2s;
    -webkit-appearance: none; min-height: 48px;
  }
  #bot-fanalca-login .nat-select:focus,
  #bot-fanalca-login .nat-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }
  #bot-fanalca-login .nat-input::placeholder { color: var(--text-soft); }
  #bot-fanalca-login .field { margin-bottom: 12px; }
  #bot-fanalca-login .field label {
    display: block; font-size: 0.72rem; font-weight: 600;
    color: var(--text-soft); margin-bottom: 8px;
    text-transform: uppercase; letter-spacing: 0.03em;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     BUTTONS
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  #bot-fanalca-login .btn {
    border: none; border-radius: 12px; padding: 11px 18px;
    font-size: 0.82rem; font-weight: 700; font-family: 'Inter', sans-serif;
    cursor: pointer; display: inline-flex; align-items: center; gap: 6px;
    transition: all 0.18s; text-decoration: none; min-height: 44px;
    -webkit-tap-highlight-color: transparent;
  }
  #bot-fanalca-login .btn:active { transform: scale(0.96); }
  #bot-fanalca-login .btn-primary { background: var(--accent); color: #fff; }
  #bot-fanalca-login .btn-primary:hover { background: var(--accent-deep); }
  #bot-fanalca-login .btn-ghost {
    background: var(--surface-2); border: 1.5px solid var(--border); color: var(--text-soft);
  }
  #bot-fanalca-login .btn-ghost:hover { border-color: var(--accent); color: var(--accent); }
  #bot-fanalca-login .btn-save {
    width: 100%; background: var(--accent); color: #fff;
    padding: 16px; font-size: 0.95rem; border-radius: 16px;
    margin-bottom: 14px; justify-content: center; border: none;
    min-height: 54px; box-shadow: 0 8px 24px rgba(232,76,30,0.3);
  }
  #bot-fanalca-login .btn-save:hover { background: var(--accent-deep); }
  #bot-fanalca-login .btn-save:disabled { opacity: 0.6; cursor: not-allowed; box-shadow: none; }
  #bot-fanalca-login .btn-add {
    background: var(--surface-2); border: 1.5px solid var(--border); color: var(--text);
    white-space: nowrap;
  }
  #bot-fanalca-login .btn-add:hover { border-color: var(--accent); color: var(--accent); }
  #bot-fanalca-login .btn-open,
  #bot-fanalca-login .btn-copy {
    background: var(--surface-2); border: 1.5px solid var(--border); color: var(--text);
  }
  #bot-fanalca-login .btn-open:hover { border-color: var(--success); color: var(--success); }
  #bot-fanalca-login .btn-copy:hover  { border-color: var(--accent); color: var(--accent); }
  #bot-fanalca-login .btn-edit-sm {
    background: rgba(232,76,30,0.1); border: 1.5px solid rgba(232,76,30,0.2); color: var(--accent);
    font-size: 0.75rem; padding: 8px 16px; border-radius: 10px;
    font-weight: 700; font-family: 'Inter', sans-serif; cursor: pointer; transition: all 0.18s;
  }
  #bot-fanalca-login .btn-edit-sm:hover { background: var(--accent); color: #fff; }
  #bot-fanalca-login .btn-view-sm {
    background: transparent; border: 1.5px solid var(--border); color: var(--text-soft);
    font-size: 0.75rem; padding: 8px 16px; border-radius: 10px; font-weight: 600;
    font-family: 'Inter', sans-serif; cursor: pointer; transition: all 0.18s;
    text-decoration: none; display: inline-flex; align-items: center;
  }
  #bot-fanalca-login .btn-view-sm:hover { border-color: rgba(255,255,255,0.2); color: var(--text); }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SPINNER / LOADING
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  #bot-fanalca-login .spinner {
    display: none; width: 16px; height: 16px;
    border: 2px solid rgba(255,255,255,0.3); border-top-color: #fff;
    border-radius: 50%; animation: fl-spin 0.7s linear infinite;
  }
  #bot-fanalca-login .sp-accent {
    display: inline-block; width: 18px; height: 18px;
    border: 2px solid rgba(232,76,30,0.2); border-top-color: var(--accent);
    border-radius: 50%; animation: fl-spin 0.7s linear infinite;
    vertical-align: middle; margin-right: 8px;
  }
  @keyframes fl-spin { to { transform: rotate(360deg); } }
  #bot-fanalca-login .ped-loading {
    text-align: center; padding: 48px 24px;
    color: var(--text-soft); font-size: 0.85rem;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     BADGES
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  #bot-fanalca-login .badge {
    display: inline-block; font-size: 0.65rem; font-weight: 700;
    padding: 3px 9px; border-radius: 20px; letter-spacing: 0.04em;
    line-height: 1.6; vertical-align: middle;
  }
  #bot-fanalca-login .badge-Ready { background: rgba(52,211,153,0.13); color: #34d399; border: 1px solid rgba(52,211,153,0.25); }
  #bot-fanalca-login .badge-Draft { background: rgba(251,191,36,0.1);  color: #fbbf24; border: 1px solid rgba(251,191,36,0.2); }
  #bot-fanalca-login .badge-Sent  { background: rgba(96,165,250,0.1);  color: #60a5fa; border: 1px solid rgba(96,165,250,0.2); }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PRODUCTS
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  #bot-fanalca-login .prod-list { display: flex; flex-direction: column; gap: 8px; }
  #bot-fanalca-login .prod-row {
    display: flex; align-items: center; gap: 10px; padding: 12px 14px;
    background: var(--surface-2); border: 1px solid var(--border); border-radius: 14px;
  }
  #bot-fanalca-login .prod-info { flex: 1; min-width: 0; }
  #bot-fanalca-login .prod-name {
    font-size: 0.84rem; font-weight: 600; color: var(--text);
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  #bot-fanalca-login .prod-sku  { font-size: 0.68rem; color: var(--text-soft); margin-top: 2px; }
  #bot-fanalca-login .prod-qty  {
    width: 60px; background: rgba(255,255,255,0.05);
    border: 1.5px solid var(--border); border-radius: 10px;
    padding: 8px; text-align: center; color: var(--text);
    font-size: 0.9rem; font-family: 'Inter', sans-serif; min-height: 40px;
  }
  #bot-fanalca-login .prod-remove {
    background: transparent; border: none; color: var(--text-soft);
    cursor: pointer; font-size: 1.1rem; padding: 6px; transition: color 0.18s;
    min-width: 32px; display: flex; align-items: center; justify-content: center;
  }
  #bot-fanalca-login .prod-remove:hover { color: var(--danger); }
  #bot-fanalca-login .prod-empty {
    color: var(--text-soft); font-size: 0.82rem; text-align: center; padding: 20px 0;
  }
  #bot-fanalca-login .add-row { display: flex; gap: 8px; align-items: flex-start; flex-wrap: wrap; }
  #bot-fanalca-login .s2-wrap { flex: 1; min-width: 160px; }
  #bot-fanalca-login .add-qty {
    width: 70px; background: rgba(255,255,255,0.05);
    border: 1.5px solid var(--border); border-radius: 14px;
    padding: 13px 8px; text-align: center; color: var(--text);
    font-size: 0.9rem; font-family: 'Inter', sans-serif; min-height: 48px;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     EDITOR PROP HEAD
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  #bot-fanalca-login .prop-head {
    background: var(--surface); border: 1.5px solid var(--border);
    border-radius: 20px; padding: 18px; margin-bottom: 14px;
  }
  #bot-fanalca-login .prop-head-title {
    font-size: 1rem; font-weight: 700; color: #fff; margin-bottom: 8px; line-height: 1.3;
  }
  #bot-fanalca-login .prop-head-meta {
    display: flex; align-items: center; gap: 8px;
    font-size: 0.75rem; color: var(--text-soft); flex-wrap: wrap;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SAVE SUCCESS
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  #bot-fanalca-login .save-success {
    background: rgba(52,211,153,0.06); border: 1.5px solid rgba(52,211,153,0.2);
    border-radius: 20px; padding: 18px; margin-bottom: 14px; display: none;
  }
  #bot-fanalca-login .ss-head { display: flex; align-items: center; gap: 14px; margin-bottom: 14px; }
  #bot-fanalca-login .ss-icon {
    width: 40px; height: 40px; border-radius: 12px;
    background: rgba(52,211,153,0.15); color: var(--success);
    display: flex; align-items: center; justify-content: center;
    font-weight: 800; font-size: 1.1rem; flex-shrink: 0;
  }
  #bot-fanalca-login .ss-title { font-weight: 700; color: var(--success); font-size: 0.9rem; }
  #bot-fanalca-login .ss-sub   { font-size: 0.75rem; color: var(--text-soft); margin-top: 3px; }
  #bot-fanalca-login .ss-url   {
    font-size: 0.72rem; color: var(--text-soft); margin-bottom: 14px;
    word-break: break-all; line-height: 1.5;
    background: rgba(255,255,255,0.03); border-radius: 10px;
    padding: 10px 12px; border: 1px solid var(--border);
  }
  #bot-fanalca-login .ss-url a { color: var(--accent); }
  #bot-fanalca-login .ss-actions { display: flex; gap: 8px; flex-wrap: wrap; }
  #bot-fanalca-login .ss-actions .btn { flex: 1; justify-content: center; }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SELECT2 THEME
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  #bot-fanalca-login .select2-container--default .select2-selection--single {
    background: rgba(255,255,255,0.05) !important; border-color: var(--border) !important;
    border-width: 1.5px !important; border-radius: 14px !important; height: 48px !important;
  }
  #bot-fanalca-login .select2-container--default .select2-selection--single .select2-selection__rendered {
    color: var(--text) !important; line-height: 48px !important; padding: 0 16px !important;
    font-size: 0.9rem !important;
  }
  #bot-fanalca-login .select2-container--default .select2-selection--single .select2-selection__arrow {
    height: 48px !important; right: 8px !important;
  }
  #bot-fanalca-login .select2-dropdown {
    background: #131320 !important; border-color: var(--border) !important;
    border-radius: 16px !important; box-shadow: 0 20px 60px rgba(0,0,0,0.8) !important;
    overflow: hidden !important;
  }
  #bot-fanalca-login .select2-container--default .select2-results__option--highlighted { background: var(--accent) !important; }
  #bot-fanalca-login .select2-results__option { color: var(--text) !important; font-size: 0.9rem !important; padding: 10px 14px !important; }
  #bot-fanalca-login .select2-search__field {
    background: rgba(255,255,255,0.05) !important; color: var(--text) !important;
    border-color: var(--border) !important; border-radius: 10px !important;
    padding: 8px 12px !important; font-size: 0.9rem !important;
  }
  #bot-fanalca-login .select2-results__group { color: var(--text-soft) !important; font-size: 0.7rem !important; }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TOAST
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  #bot-fanalca-login .fl-toast {
    position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
    z-index: 9999; background: #1a1a2e; border: 1px solid var(--border);
    border-radius: 14px; padding: 12px 20px; font-size: 0.82rem; color: var(--text);
    box-shadow: 0 16px 48px rgba(0,0,0,0.6); display: none;
    font-family: 'Inter', sans-serif; white-space: nowrap; font-weight: 500;
  }
  #bot-fanalca-login .fl-toast.ok  { border-color: rgba(52,211,153,0.4); color: var(--success); }
  #bot-fanalca-login .fl-toast.err { border-color: rgba(248,113,113,0.4); color: var(--danger); }
</style>

<!-- HTML -->
<div id="bot-fanalca-login">

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• VIEW: LOGIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="view active" id="view-login">
    <div class="login-wrap">

      <div class="login-brand">
        <div class="login-brand-icon">ğŸš—</div>
        <div class="login-brand-name">Fanalca</div>
        <div class="login-brand-sub">Portal de propuestas</div>
      </div>

      <div class="login-card">
        <div class="login-title">Iniciar sesiÃ³n</div>
        <div class="login-err" id="login-err"></div>

        <div class="field">
          <label for="login-email">Usuario</label>
          <input type="text" id="login-email" placeholder="tu@email.com" autocomplete="username">
        </div>
        <div class="field">
          <label for="login-password">ContraseÃ±a</label>
          <input type="password" id="login-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password">
        </div>

        <button class="btn-login" id="btn-login" onclick="flDoLogin()">
          <span id="btn-login-text">Ingresar</span>
          <span class="spinner" id="sp-login"></span>
        </button>
      </div>

    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• APP HEADER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="app-header" id="fl-app-header" style="display:none">
    <div class="app-header-left">
      <button class="btn-icon" id="fl-btn-back" onclick="flGoHome()" style="display:none" title="Inicio">â†</button>
      <span class="header-page" id="fl-header-page">Inicio</span>
    </div>
    <div class="app-header-right">
      <span class="user-chip" id="header-user-name">â€”</span>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• VIEW: HOME â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="view" id="view-home">
    <div class="home-wrap">
      <div class="home-greeting">Hola,<br><em id="home-user-name">â€”</em></div>
      <div class="home-sub">Â¿QuÃ© quieres hacer hoy?</div>

      <div class="home-section-title">Acciones rÃ¡pidas</div>
      <div class="home-cards">

        <div class="home-card" onclick="flGoMyProposals()">
          <div class="hc-icon-wrap blue">ğŸ“‹</div>
          <div class="hc-body">
            <div class="hc-title">Ver propuestas</div>
            <div class="hc-desc">Revisa el estado de tus propuestas</div>
          </div>
          <div class="hc-arrow">â€º</div>
        </div>

        <div class="home-card" onclick="flGoCreate()">
          <div class="hc-icon-wrap green">âœ¨</div>
          <div class="hc-body">
            <div class="hc-title">Crear propuesta</div>
            <div class="hc-desc">Genera una nueva propuesta</div>
          </div>
          <div class="hc-arrow">â€º</div>
        </div>

        <div class="home-card" onclick="flGoSearch()">
          <div class="hc-icon-wrap orange">âœï¸</div>
          <div class="hc-body">
            <div class="hc-title">Editar propuesta</div>
            <div class="hc-desc">Busca y edita por asesor</div>
          </div>
          <div class="hc-arrow">â€º</div>
        </div>

      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• VIEW: MIS PROPUESTAS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="view" id="view-my-proposals">
    <div class="view-scroll">
      <div class="view-title">Mis propuestas</div>
      <div class="filter-bar">
        <button class="filter-btn active" data-status="all"   onclick="flFilterMy('all',   this)">Todas</button>
        <button class="filter-btn"        data-status="Ready" onclick="flFilterMy('Ready', this)">Ready</button>
        <button class="filter-btn"        data-status="Draft" onclick="flFilterMy('Draft', this)">Draft</button>
        <button class="filter-btn"        data-status="Sent"  onclick="flFilterMy('Sent',  this)">Sent</button>
      </div>
      <div id="fl-my-list">
        <div class="ped-loading"><div class="sp-accent"></div> Cargando...</div>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• VIEW: CREAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="view" id="view-create">
    <div class="view-scroll">
      <div class="view-title">Crear propuesta</div>

      <div class="ped-card">
        <div class="card-sec">Datos</div>
        <div class="field">
          <label>TÃ­tulo</label>
          <input type="text" id="fl-create-title" class="nat-input" placeholder="Ej: Propuesta comercial Fanalca">
        </div>
        <div class="field" style="margin-top:10px">
          <label>Estado inicial</label>
          <select id="fl-create-status" class="nat-select">
            <option value="Draft">Draft â€” Borrador</option>
            <option value="Ready">Ready â€” Lista para enviar</option>
          </select>
        </div>
      </div>

      <div class="ped-card">
        <div class="card-sec">Productos</div>
        <div id="fl-create-products"><div class="prod-empty">Sin productos aÃºn.</div></div>
      </div>

      <div class="ped-card">
        <div class="card-sec">Agregar producto</div>
        <div class="add-row">
          <div class="s2-wrap">
            <select id="fl-create-add-prod"><option value="">Buscar en catÃ¡logo...</option></select>
          </div>
          <input type="number" class="add-qty" id="fl-create-add-qty" value="1" min="1" max="999" placeholder="Cant.">
          <button class="btn btn-add" onclick="flCreateAddProduct()">+ Agregar</button>
        </div>
      </div>

      <button class="btn btn-save" id="fl-btn-create" onclick="flCreateProposal()">
        <span id="fl-btn-create-text">Crear propuesta</span>
        <span class="spinner" id="fl-sp-create"></span>
      </button>

      <div class="save-success" id="fl-create-success">
        <div class="ss-head">
          <div class="ss-icon">âœ“</div>
          <div>
            <div class="ss-title">Propuesta creada</div>
            <div class="ss-sub" id="fl-create-sub"></div>
          </div>
        </div>
        <div class="ss-url"><a id="fl-create-url" href="#" target="_blank" rel="noopener"></a></div>
        <div class="ss-actions">
          <button class="btn btn-open" id="fl-create-open-btn">Abrir â†’</button>
          <button class="btn btn-ghost" onclick="flGoHome()">Inicio</button>
        </div>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• VIEW: BUSCAR Y EDITAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="view" id="view-search">
    <div class="view-scroll">
      <div class="view-title">Editar propuesta</div>

      <div class="ped-card">
        <div class="card-sec">Asesor</div>
        <label class="flabel">Selecciona el asesor</label>
        <select id="fl-agent-select"><option value="">Cargando asesores...</option></select>
        <button class="btn btn-primary" id="fl-btn-load" onclick="flLoadSearchProposals()" disabled style="margin-top:14px; width:100%; justify-content:center">
          Ver propuestas <span class="spinner" id="fl-sp-load"></span>
        </button>
      </div>

      <div id="fl-search-list" style="display:none">
        <div class="filter-bar">
          <button class="filter-btn active" data-status="all"   onclick="flFilterSearch('all',   this)">Todas</button>
          <button class="filter-btn"        data-status="Ready" onclick="flFilterSearch('Ready', this)">Ready</button>
          <button class="filter-btn"        data-status="Draft" onclick="flFilterSearch('Draft', this)">Draft</button>
          <button class="filter-btn"        data-status="Sent"  onclick="flFilterSearch('Sent',  this)">Sent</button>
        </div>
        <div id="fl-search-proposals"></div>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• VIEW: EDITOR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="view" id="view-editor">
    <div class="view-scroll">

      <div class="prop-head">
        <div class="prop-head-title" id="fl-ed-title">â€”</div>
        <div class="prop-head-meta">
          <span id="fl-ed-num"></span>
          <span id="fl-ed-badge"></span>
        </div>
      </div>

      <div class="ped-card">
        <div class="card-sec">Estado</div>
        <select class="nat-select" id="fl-ed-status">
          <option value="Draft">Draft â€” Borrador</option>
          <option value="Ready">Ready â€” Lista para enviar</option>
          <option value="Sent">Sent â€” Enviada</option>
        </select>
      </div>

      <div class="ped-card">
        <div class="card-sec">Productos</div>
        <div id="fl-ed-products">
          <div class="ped-loading"><div class="sp-accent"></div> Cargando...</div>
        </div>
      </div>

      <div class="ped-card">
        <div class="card-sec">Agregar producto</div>
        <div class="add-row">
          <div class="s2-wrap">
            <select id="fl-add-prod"><option value="">Buscar en catÃ¡logo...</option></select>
          </div>
          <input type="number" class="add-qty" id="fl-add-qty" value="1" min="1" max="999" placeholder="Cant.">
          <button class="btn btn-add" onclick="flAddProduct()">+ Agregar</button>
        </div>
      </div>

      <button class="btn btn-save" id="fl-btn-save" onclick="flSaveProposal()">
        <span id="fl-btn-save-text">Guardar cambios</span>
        <span class="spinner" id="fl-sp-save"></span>
      </button>

      <div class="save-success" id="fl-save-success">
        <div class="ss-head">
          <div class="ss-icon">âœ“</div>
          <div>
            <div class="ss-title">Guardado correctamente</div>
            <div class="ss-sub" id="fl-ss-sub"></div>
          </div>
        </div>
        <div class="ss-url"><a id="fl-prop-url" href="#" target="_blank" rel="noopener"></a></div>
        <div class="ss-actions">
          <button class="btn btn-open" onclick="flOpenUrl()">Abrir â†’</button>
          <button class="btn btn-copy" id="fl-btn-copy" onclick="flCopyUrl()">Copiar enlace</button>
        </div>
      </div>

    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• BOTTOM NAV â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div class="bottom-nav" id="fl-bottom-nav">
    <button class="nav-tab" id="nav-tab-my"     onclick="flGoMyProposals()">
      <span class="nav-tab-icon">ğŸ“‹</span>
      <span class="nav-tab-label">Propuestas</span>
    </button>
    <button class="nav-tab" id="nav-tab-create" onclick="flGoCreate()">
      <span class="nav-tab-icon">âœ¨</span>
      <span class="nav-tab-label">Crear</span>
    </button>
    <button class="nav-tab" id="nav-tab-search" onclick="flGoSearch()">
      <span class="nav-tab-icon">âœï¸</span>
      <span class="nav-tab-label">Editar</span>
    </button>
  </div>

</div><!-- /bot-fanalca-login -->

<!-- Toast -->
<div class="fl-toast" id="fl-toast"></div>

<!-- SCRIPTS â€” orden exacto -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
<script src="https://s3.amazonaws.com/cdn.nodriza.io/sdk/nodriza@lastest/nodriza-sdk.bundle.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.11/lodash.core.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
  // â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var domain      = 'customer-design.prolibu.com';
  var rolesString = 'agent';
  var apiKey      = '56a69869-bf0a-4650-98e9-fcd9680b31d5';

  // â”€â”€ SesiÃ³n â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var flToken       = '';
  var flAuthHeaders = {};
  var flCurrentUser = null;
  var flNodriza     = null;

  // â”€â”€ Datos â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var flAgentsList          = [];
  var flMyProposalsList     = [];
  var flSearchProposalsList = [];
  var flProductsCatalog     = [];
  var flCurrentProposal     = null;
  var flCurrentProducts     = [];
  var flCreateProducts      = [];
  var flPropUrl             = '';
  var flCreatePropUrl       = '';

  // â”€â”€ Utilidades â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function flToast(msg, type) {
    var $t = $('#fl-toast');
    $t.text(msg).removeClass('ok err').addClass(type === 'ok' ? 'ok' : 'err').fadeIn(200);
    setTimeout(function () { $t.fadeOut(400); }, 3000);
  }

  function flBadge(s) {
    var valid = ['Ready', 'Draft', 'Sent'];
    var cls = valid.indexOf(s) >= 0 ? s : 'Draft';
    return '<span class="badge badge-' + cls + '">' + s + '</span>';
  }

  // â”€â”€ NavegaciÃ³n â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var FL_TAB_MAP = {
    'view-my-proposals': 'nav-tab-my',
    'view-create':       'nav-tab-create',
    'view-search':       'nav-tab-search'
  };

  function flShowView(id, title) {
    $('.view').removeClass('active').hide();
    $('#' + id).addClass('active').show();

    if (id === 'view-login') {
      $('#fl-app-header').hide();
      $('#fl-bottom-nav').removeClass('visible');
    } else {
      $('#fl-app-header').css('display', 'flex');
      $('#fl-header-page').text(title || '');

      // BotÃ³n atrÃ¡s: oculto en home, visible en editor, oculto en tabs
      if (id === 'view-home' || id === 'view-my-proposals' || id === 'view-create' || id === 'view-search') {
        $('#fl-btn-back').hide();
      } else {
        $('#fl-btn-back').show();
      }

      // Bottom nav: visible en tabs, oculto en home y editor
      if (id === 'view-home' || id === 'view-editor') {
        $('#fl-bottom-nav').removeClass('visible');
      } else {
        $('#fl-bottom-nav').addClass('visible');
      }

      // Marcar tab activo
      $('.nav-tab').removeClass('active');
      var tabId = FL_TAB_MAP[id];
      if (tabId) $('#' + tabId).addClass('active');
    }
  }

  function flGoHome() {
    flShowView('view-home', 'Inicio');
  }

  function flGoMyProposals() {
    flShowView('view-my-proposals', 'Mis propuestas');
    flLoadMyProposals();
  }

  function flGoCreate() {
    flShowView('view-create', 'Crear propuesta');
    flCreateProducts = [];
    flRenderCreateProducts();
    $('#fl-create-title').val('');
    $('#fl-create-status').val('Draft');
    $('#fl-create-success').hide();
    if ($('#fl-create-add-prod').data('select2')) $('#fl-create-add-prod').select2('destroy');
    var opts = '<option value="">Buscar en catÃ¡logo...</option>';
    _.sortBy(flProductsCatalog, 'name').forEach(function (p) {
      opts += '<option value="' + p.sku + '">' + p.name + ' (' + p.sku + ')</option>';
    });
    $('#fl-create-add-prod').html(opts).select2({ width: '100%', placeholder: 'Buscar en catÃ¡logo...' });
  }

  function flGoSearch() {
    flShowView('view-search', 'Editar propuesta');
    $('#fl-search-list').hide();
    if ($('#fl-agent-select').data('select2')) $('#fl-agent-select').select2('destroy');
    var opts = '<option value="">Seleccione un asesor</option>';
    flAgentsList.forEach(function (a) {
      opts += '<option value="' + a.email + '">' + a.firstName + ' ' + a.lastName + '</option>';
    });
    $('#fl-agent-select').html(opts).select2({ width: '100%', placeholder: 'Seleccione un asesor' });
    $('#fl-agent-select').on('change', function () {
      $('#fl-btn-load').prop('disabled', !$(this).val());
    });
    if (flCurrentUser && flCurrentUser.email) {
      var match = flAgentsList.find(function (a) { return a.email === flCurrentUser.email; });
      if (match) $('#fl-agent-select').val(match.email).trigger('change');
    }
  }

  // â”€â”€ LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function flDoLogin() {
    var email    = $('#login-email').val().trim();
    var password = $('#login-password').val();
    if (!email || !password) { flShowLoginErr('Completa todos los campos'); return; }

    $('#btn-login').prop('disabled', true);
    $('#btn-login-text').text('Ingresando...');
    $('#sp-login').show();
    $('#login-err').hide();

    var loginBody = { username: email, password: password, accessToken: apiKey };
    console.log('[LOGIN] POST body:', loginBody);

    $.ajax({
      url: 'https://' + domain + '/v1/user/login',
      type: 'POST', contentType: 'application/json',
      data: JSON.stringify(loginBody),
      success: function (res) {
        console.log('[LOGIN] âœ… Response:', JSON.stringify(res, null, 2));
        var data      = res.data || res;
        flToken       = data.token || data.accessToken || data.access_token || data.jwt || '';
        flCurrentUser = data.user || data.userData || data.profile || { email: email, firstName: email.split('@')[0] };
        console.log('[LOGIN] token:', flToken);

        if (!flToken) {
          flShowLoginErr('No se recibiÃ³ token. Revisa F12.');
          flResetLoginBtn(); return;
        }

        flAuthHeaders = { Authorization: 'Bearer ' + flToken };
        flNodriza     = new Nodriza({ hostname: domain });

        var name = flCurrentUser.firstName || flCurrentUser.name || flCurrentUser.email || email;
        $('#header-user-name').text(name);
        $('#home-user-name').text(name);

        flShowView('view-home', 'Inicio');
        flResetLoginBtn();
        flLoadAgents();
        flLoadCatalog();
      },
      error: function (e) {
        console.error('[LOGIN] âŒ', e.status, e.responseText);
        var msg = 'Error ' + e.status;
        try { var b = JSON.parse(e.responseText); msg = b.message || b.error || b.msg || msg; } catch (_) {}
        flShowLoginErr(msg);
        flResetLoginBtn();
      }
    });
  }

  function flShowLoginErr(msg) { $('#login-err').text(msg).show(); }
  function flResetLoginBtn() {
    $('#btn-login').prop('disabled', false);
    $('#btn-login-text').text('Ingresar');
    $('#sp-login').hide();
  }

  $(document).on('keydown', '#login-email, #login-password', function (e) {
    if (e.key === 'Enter') flDoLogin();
  });

  // â”€â”€ LOGOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function flDoLogout() {
    flToken = ''; flAuthHeaders = {}; flCurrentUser = null; flNodriza = null;
    flAgentsList = []; flMyProposalsList = []; flSearchProposalsList = [];
    flProductsCatalog = []; flCurrentProposal = null;
    flCurrentProducts = []; flCreateProducts = [];
    $('#login-email').val(''); $('#login-password').val('');
    $('#login-err').hide();
    flShowView('view-login');
  }

  // â”€â”€ AJAX HELPER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function flApi(method, path, data, cb, cbErr) {
    var opts = {
      url: 'https://' + domain + path,
      type: method, headers: flAuthHeaders, success: cb,
      error: cbErr || function (e) { console.error(method, path, e.status, e.responseText); }
    };
    if (method === 'PUT' || method === 'POST') {
      opts.data = JSON.stringify(data); opts.contentType = 'application/json';
    } else { opts.data = data; }
    $.ajax(opts);
  }

  // â”€â”€ AGENTES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function flLoadAgents() {
    $.ajax({
      url: 'https://' + domain + '/v1/publicservices/getAgents',
      type: 'GET', data: { status: 'active', roles: [rolesString] },
      success: function (res) {
        var list = Array.isArray(res) ? res : (res.results || []);
        flAgentsList = list.map(function (a) {
          return { email: a.email || '', firstName: a.firstName || '', lastName: a.lastName || '', id: a.id || a._id || '' };
        });
        console.log('Asesores:', flAgentsList.length);
      },
      error: function (e) { console.error('loadAgents:', e); }
    });
  }

  // â”€â”€ MIS PROPUESTAS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function flLoadMyProposals() {
    $('#fl-my-list').html('<div class="ped-loading"><div class="sp-accent"></div> Cargando...</div>');

    var tryLoad = function (attempts) {
      var myAgent = flAgentsList.find(function (a) { return a.email === (flCurrentUser && flCurrentUser.email); });
      if (!myAgent && attempts < 8) {
        setTimeout(function () { tryLoad(attempts + 1); }, 600); return;
      }
      if (!myAgent) {
        $('#fl-my-list').html('<div class="prop-empty">Tu usuario no aparece en la lista de asesores.</div>'); return;
      }
      flApi('GET', '/v1/proposal', { createdBy: myAgent.id, limit: 200 },
        function (res) {
          var list = Array.isArray(res) ? res : (res.data || res.results || []);
          flMyProposalsList = list;
          console.log('Mis propuestas:', list.length);
          $('#view-my-proposals .filter-btn').removeClass('active');
          $('#view-my-proposals .filter-btn[data-status="all"]').addClass('active');
          flRenderPropCards(flMyProposalsList, '#fl-my-list');
        },
        function (e) {
          flToast('Error ' + e.status + ' al cargar propuestas', 'err');
          $('#fl-my-list').html('<div class="prop-empty">No se pudieron cargar las propuestas.</div>');
        }
      );
    };
    tryLoad(0);
  }

  function flFilterMy(status, btn) {
    $('#view-my-proposals .filter-btn').removeClass('active');
    $(btn).addClass('active');
    var list = status === 'all' ? flMyProposalsList : flMyProposalsList.filter(function (p) { return p.status === status; });
    flRenderPropCards(list, '#fl-my-list');
  }

  // â”€â”€ BUSCAR Y EDITAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function flLoadSearchProposals() {
    var email = $('#fl-agent-select').val();
    if (!email) return flToast('Selecciona un asesor', 'err');
    var agent = flAgentsList.find(function (a) { return a.email === email; });
    if (!agent || !agent.id) return flToast('No se encontrÃ³ el ID del asesor', 'err');

    $('#fl-btn-load').prop('disabled', true); $('#fl-sp-load').show();
    $('#fl-search-list').hide();
    console.log('Propuestas de:', agent.id);

    flApi('GET', '/v1/proposal', { createdBy: agent.id, limit: 200 },
      function (res) {
        var list = Array.isArray(res) ? res : (res.data || res.results || []);
        flSearchProposalsList = list;
        console.log('Propuestas asesor:', list.length);
        $('#fl-btn-load').prop('disabled', false); $('#fl-sp-load').hide();
        $('#view-search .filter-btn').removeClass('active');
        $('#view-search .filter-btn[data-status="all"]').addClass('active');
        flRenderPropCards(flSearchProposalsList, '#fl-search-proposals');
        $('#fl-search-list').show();
      },
      function (e) {
        flToast('Error ' + e.status, 'err');
        $('#fl-btn-load').prop('disabled', false); $('#fl-sp-load').hide();
      }
    );
  }

  function flFilterSearch(status, btn) {
    $('#view-search .filter-btn').removeClass('active');
    $(btn).addClass('active');
    var list = status === 'all' ? flSearchProposalsList : flSearchProposalsList.filter(function (p) { return p.status === status; });
    flRenderPropCards(list, '#fl-search-proposals');
  }

  // â”€â”€ RENDER LISTA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function flRenderPropCards(list, selector) {
    if (!list.length) {
      $(selector).html('<div class="prop-empty">No hay propuestas para mostrar.</div>'); return;
    }
    var html = '<div class="prop-cards">';
    list.forEach(function (p) {
      var id    = p.id || p._id;
      var title = p.title || p.proposalNumber || id || '(Sin tÃ­tulo)';
      var num   = p.proposalNumber ? 'NÂ° ' + p.proposalNumber : '';
      var date  = p.createdAt ? new Date(p.createdAt).toLocaleDateString('es-CO') : '';
      var url   = p.url || p.link || p.shareUrl || ('https://' + domain + '/proposal/' + id);
      html +=
        '<div class="prop-card">' +
          '<div class="pc-info">' +
            '<div class="pc-title">' + title + '</div>' +
            '<div class="pc-meta">' +
              flBadge(p.status || 'Draft') +
              (num  ? '<span>' + num  + '</span>' : '') +
              (date ? '<span>' + date + '</span>' : '') +
            '</div>' +
          '</div>' +
          '<div class="pc-actions">' +
            '<a class="btn-view-sm" href="' + url + '" target="_blank" rel="noopener">Abrir</a>' +
            '<button class="btn-edit-sm" onclick="flEditProposal(\'' + id + '\')">Editar</button>' +
          '</div>' +
        '</div>';
    });
    html += '</div>';
    $(selector).html(html);
  }

  // â”€â”€ EDITAR PROPUESTA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function flEditProposal(id) {
    flShowView('view-editor', 'Editar');
    $('#fl-save-success').hide();
    $('#fl-ed-products').html('<div class="ped-loading"><div class="sp-accent"></div> Cargando...</div>');

    flApi('GET', '/v1/proposal/' + id, {},
      function (res) {
        console.log('Detalle:', JSON.stringify(res, null, 2));
        flCurrentProposal = res;
        flCurrentProducts = flParseProducts(res.products);
        flRenderEditor();
        if ($('#fl-add-prod').data('select2')) $('#fl-add-prod').select2('destroy');
        var opts = '<option value="">Buscar en catÃ¡logo...</option>';
        _.sortBy(flProductsCatalog, 'name').forEach(function (p) {
          opts += '<option value="' + p.sku + '">' + p.name + ' (' + p.sku + ')</option>';
        });
        $('#fl-add-prod').html(opts).select2({ width: '100%', placeholder: 'Buscar en catÃ¡logo...' });
      },
      function (e) {
        flToast('Error al cargar propuesta: ' + e.status, 'err');
        flGoHome();
      }
    );
  }

  // â”€â”€ PRODUCTOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function flParseProducts(raw) {
    if (!raw) return [];
    if (Array.isArray(raw)) return raw.map(flNormProd);
    if (typeof raw === 'string') { try { return JSON.parse(raw).map(flNormProd); } catch (_) { return []; } }
    if (typeof raw === 'object') return [flNormProd(raw)];
    return [];
  }

  function flNormProd(p) {
    var sku  = p.id || p.sku || p._id || '';
    var name = p.name || '';
    if (!name && flProductsCatalog.length) {
      var f = flProductsCatalog.find(function (x) { return x.sku === sku; });
      if (f) name = f.name;
    }
    return { id: sku, quantity: parseInt(p.quantity) || 1, name: name || sku };
  }

  function flRenderEditor() {
    var p = flCurrentProposal;
    $('#fl-ed-title').text(p.title || '(Sin tÃ­tulo)');
    $('#fl-ed-num').text(p.proposalNumber ? 'NÂ° ' + p.proposalNumber : '');
    $('#fl-ed-badge').html(flBadge(p.status || 'Draft'));
    $('#fl-ed-status').val(p.status || 'Draft');
    flRenderProductList();
  }

  function flRenderProductList() {
    var $list = $('#fl-ed-products');
    if (!flCurrentProducts.length) {
      $list.html('<div class="prod-empty">Sin productos. Agrega uno abajo.</div>'); return;
    }
    var html = '<div class="prod-list">';
    flCurrentProducts.forEach(function (prod, i) {
      html +=
        '<div class="prod-row">' +
          '<div class="prod-info">' +
            '<div class="prod-name">' + (prod.name || prod.id) + '</div>' +
            '<div class="prod-sku">'  + prod.id + '</div>' +
          '</div>' +
          '<input type="number" class="prod-qty" value="' + prod.quantity + '" min="1" max="999" data-idx="' + i + '">' +
          '<button class="prod-remove" onclick="flRemoveProduct(' + i + ')">âœ•</button>' +
        '</div>';
    });
    html += '</div>';
    $list.html(html);
    $list.find('.prod-qty').on('change input', function () {
      var idx = parseInt($(this).data('idx'));
      flCurrentProducts[idx].quantity = Math.max(1, parseInt($(this).val()) || 1);
    });
  }

  function flRemoveProduct(idx) {
    flCurrentProducts.splice(idx, 1); flRenderProductList(); flToast('Producto eliminado', 'ok');
  }

  function flAddProduct() {
    var sku = $('#fl-add-prod').val();
    var qty = Math.max(1, parseInt($('#fl-add-qty').val()) || 1);
    if (!sku) return flToast('Selecciona un producto', 'err');
    var exists = flCurrentProducts.find(function (p) { return p.id === sku; });
    if (exists) {
      exists.quantity += qty; flRenderProductList(); flToast('Cantidad actualizada: ' + exists.quantity, 'ok');
    } else {
      var cat = flProductsCatalog.find(function (p) { return p.sku === sku; });
      flCurrentProducts.push({ id: sku, quantity: qty, name: cat ? cat.name : sku });
      flRenderProductList(); flToast('Producto agregado', 'ok');
    }
    $('#fl-add-prod').val('').trigger('change');
    $('#fl-add-qty').val(1);
  }

  // â”€â”€ GUARDAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function flSaveProposal() {
    if (!flCurrentProposal) return;
    var id = flCurrentProposal.id || flCurrentProposal._id;
    $('#fl-btn-save').prop('disabled', true);
    $('#fl-btn-save-text').text('Guardando...');
    $('#fl-sp-save').show();
    $('#fl-save-success').hide();

    var newStatus       = $('#fl-ed-status').val();
    var productsPayload = flCurrentProducts.map(function (p) { return { id: p.id, quantity: p.quantity }; });
    var body            = { status: newStatus, products: productsPayload };
    console.log('PUT /v1/proposal/' + id, body);

    function onOk(res) {
      flCurrentProposal = res;
      var pid = res.id || res._id || id;
      flPropUrl = res.url || res.link || res.shareUrl || res.proposalUrl || ('https://' + domain + '/proposal/' + pid);
      console.log('URL propuesta:', flPropUrl);
      $('#fl-ed-badge').html(flBadge(newStatus));
      $('#fl-ss-sub').text('Estado: ' + newStatus);
      $('#fl-prop-url').attr('href', flPropUrl).text(flPropUrl);
      $('#fl-save-success').fadeIn(250);
      $('#fl-btn-save').prop('disabled', false);
      $('#fl-btn-save-text').text('Guardar cambios');
      $('#fl-sp-save').hide();
    }

    function onErr(e, retry) {
      if (e.status === 400 && retry) {
        body.products = JSON.stringify(productsPayload);
        $.ajax({
          url: 'https://' + domain + '/v1/proposal/' + id, type: 'PUT',
          data: JSON.stringify(body), contentType: 'application/json', headers: flAuthHeaders,
          success: onOk, error: function (e2) { onErr(e2, false); }
        });
      } else {
        flToast('Error al guardar (' + e.status + ')', 'err');
        $('#fl-btn-save').prop('disabled', false);
        $('#fl-btn-save-text').text('Guardar cambios');
        $('#fl-sp-save').hide();
      }
    }

    $.ajax({
      url: 'https://' + domain + '/v1/proposal/' + id, type: 'PUT',
      data: JSON.stringify(body), contentType: 'application/json', headers: flAuthHeaders,
      success: onOk, error: function (e) { onErr(e, true); }
    });
  }

  function flOpenUrl() { if (flPropUrl) window.open(flPropUrl, '_blank'); }
  function flCopyUrl() {
    if (!flPropUrl) return;
    var done = function () {
      $('#fl-btn-copy').text('Â¡Copiado!');
      setTimeout(function () { $('#fl-btn-copy').text('Copiar enlace'); }, 2000);
    };
    if (navigator.clipboard) { navigator.clipboard.writeText(flPropUrl).then(done); }
    else {
      var tmp = document.createElement('input'); tmp.value = flPropUrl;
      document.body.appendChild(tmp); tmp.select(); document.execCommand('copy'); document.body.removeChild(tmp); done();
    }
  }

  // â”€â”€ CREAR PROPUESTA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function flRenderCreateProducts() {
    var $list = $('#fl-create-products');
    if (!flCreateProducts.length) {
      $list.html('<div class="prod-empty">Sin productos aÃºn.</div>'); return;
    }
    var html = '<div class="prod-list">';
    flCreateProducts.forEach(function (prod, i) {
      html +=
        '<div class="prod-row">' +
          '<div class="prod-info">' +
            '<div class="prod-name">' + (prod.name || prod.id) + '</div>' +
            '<div class="prod-sku">'  + prod.id + '</div>' +
          '</div>' +
          '<input type="number" class="prod-qty" value="' + prod.quantity + '" min="1" max="999" data-cidx="' + i + '">' +
          '<button class="prod-remove" onclick="flCreateRemoveProduct(' + i + ')">âœ•</button>' +
        '</div>';
    });
    html += '</div>';
    $list.html(html);
    $list.find('.prod-qty').on('change input', function () {
      var idx = parseInt($(this).data('cidx'));
      flCreateProducts[idx].quantity = Math.max(1, parseInt($(this).val()) || 1);
    });
  }

  function flCreateAddProduct() {
    var sku = $('#fl-create-add-prod').val();
    var qty = Math.max(1, parseInt($('#fl-create-add-qty').val()) || 1);
    if (!sku) return flToast('Selecciona un producto', 'err');
    var exists = flCreateProducts.find(function (p) { return p.id === sku; });
    if (exists) {
      exists.quantity += qty; flRenderCreateProducts(); flToast('Cantidad actualizada: ' + exists.quantity, 'ok');
    } else {
      var cat = flProductsCatalog.find(function (p) { return p.sku === sku; });
      flCreateProducts.push({ id: sku, quantity: qty, name: cat ? cat.name : sku });
      flRenderCreateProducts(); flToast('Producto agregado', 'ok');
    }
    $('#fl-create-add-prod').val('').trigger('change');
    $('#fl-create-add-qty').val(1);
  }

  function flCreateRemoveProduct(idx) {
    flCreateProducts.splice(idx, 1); flRenderCreateProducts(); flToast('Producto eliminado', 'ok');
  }

  function flCreateProposal() {
    var title = $('#fl-create-title').val().trim();
    if (!title) return flToast('Ingresa un tÃ­tulo', 'err');

    var myAgent         = flAgentsList.find(function (a) { return a.email === (flCurrentUser && flCurrentUser.email); });
    var productsPayload = flCreateProducts.map(function (p) { return { id: p.id, quantity: p.quantity }; });
    var body = { title: title, status: $('#fl-create-status').val(), products: productsPayload };
    if (myAgent) body.createdBy = myAgent.id;

    console.log('POST /v1/proposal', body);
    $('#fl-btn-create').prop('disabled', true);
    $('#fl-btn-create-text').text('Creando...');
    $('#fl-sp-create').show();
    $('#fl-create-success').hide();

    function onOk(res) {
      console.log('Propuesta creada:', res);
      var pid = res.id || res._id;
      flCreatePropUrl = res.url || res.link || res.shareUrl || ('https://' + domain + '/proposal/' + pid);
      console.log('URL:', flCreatePropUrl);
      $('#fl-create-sub').text('"' + title + '" creada correctamente');
      $('#fl-create-url').attr('href', flCreatePropUrl).text(flCreatePropUrl);
      $('#fl-create-open-btn').off('click').on('click', function () { window.open(flCreatePropUrl, '_blank'); });
      $('#fl-create-success').fadeIn(250);
      $('#fl-btn-create').prop('disabled', false);
      $('#fl-btn-create-text').text('Crear propuesta');
      $('#fl-sp-create').hide();
    }

    function onErr(e, retry) {
      if (e.status === 400 && retry) {
        body.products = JSON.stringify(productsPayload);
        $.ajax({
          url: 'https://' + domain + '/v1/proposal', type: 'POST',
          data: JSON.stringify(body), contentType: 'application/json', headers: flAuthHeaders,
          success: onOk, error: function (e2) { onErr(e2, false); }
        });
      } else {
        flToast('Error al crear (' + e.status + ')', 'err');
        $('#fl-btn-create').prop('disabled', false);
        $('#fl-btn-create-text').text('Crear propuesta');
        $('#fl-sp-create').hide();
      }
    }

    $.ajax({
      url: 'https://' + domain + '/v1/proposal', type: 'POST',
      data: JSON.stringify(body), contentType: 'application/json', headers: flAuthHeaders,
      success: onOk, error: function (e) { onErr(e, true); }
    });
  }

  // â”€â”€ CATÃLOGO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function flLoadCatalog() {
    flApi('GET', '/v1/product?disabled=false', {},
      function (res) {
        var items = res.data || res || [];
        flProductsCatalog = items.map(function (p) { return { sku: p.sku, name: p.name }; });
        console.log('CatÃ¡logo:', flProductsCatalog.length, 'productos');
      }
    );
  }

  // â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  $(document).ready(function () {
    flShowView('view-login');
  });
</script>
